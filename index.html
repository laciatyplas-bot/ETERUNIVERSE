<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eterniverse Master Premium PRO v8.0</title>
  <meta name="description" content="Profesjonalny system kreacji literackiej z pe≈ÇnƒÖ hierarchiƒÖ i Bella AI">
  
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500&display=swap');

    :root {
      --bg: #0a0a10;
      --panel: #121218;
      --border: #252530;
      --accent: #00e0ff;
      --gold: #f0d040;
      --text: #f8f8fc;
      --muted: #a8b0d0;
      --shadow: 0 12px 40px rgba(0,0,0,0.6);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      overflow: hidden;
    }

    header {
      padding: 2.2rem;
      text-align: center;
      background: rgba(18,18,24,0.95);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.2rem;
      color: var(--accent);
      letter-spacing: 4px;
      text-shadow: 0 0 20px rgba(0,224,255,0.4);
    }

    header p {
      margin-top: 0.6rem;
      color: var(--muted);
      font-weight: 300;
      font-size: 1.1rem;
    }

    .toolbar {
      padding: 1.3rem 2rem;
      background: rgba(18,18,24,0.9);
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      justify-content: center;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    button, select {
      padding: 0.9rem 1.8rem;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover, select:hover {
      background: rgba(0,224,255,0.15);
      border-color: var(--accent);
      transform: translateY(-3px);
    }

    button.primary { background: var(--accent); color: #000; font-weight: 600; border: none; }
    button.gold { background: var(--gold); color: #000; font-weight: 600; border: none; }

    .layout {
      display: grid;
      grid-template-columns: 360px 1fr 400px;
      gap: 2rem;
      padding: 2rem;
      overflow: hidden;
    }

    .section {
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .section h2 {
      font-size: 1.5rem;
      color: var(--accent);
      margin-bottom: 1.4rem;
      font-weight: 600;
    }

    .scrollable {
      overflow-y: auto;
      flex: 1;
      padding-right: 0.5rem;
    }

    #current-path {
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: 1rem;
      opacity: 0.8;
    }

    #book-title {
      width: 100%;
      padding: 1.2rem;
      font-size: 2.2rem;
      background: transparent;
      border: none;
      border-bottom: 4px solid var(--gold);
      color: var(--gold);
      text-align: center;
      margin-bottom: 1.8rem;
      font-weight: 600;
    }

    #book-title:focus { outline: none; border-color: var(--accent); }

    textarea {
      flex: 1;
      background: rgba(15,15,25,0.95);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.8rem;
      color: var(--text);
      font-size: 1.15rem;
      line-height: 1.9;
      resize: none;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,224,255,0.15);
    }

    .tree-node {
      padding: 1rem 1.2rem;
      margin-bottom: 0.8rem;
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      border-left: 4px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tree-node:hover {
      background: rgba(0,224,255,0.12);
      border-left-color: var(--accent);
      transform: translateX(8px);
    }

    .tree-node.selected {
      border-left-color: var(--gold);
      background: rgba(240,208,64,0.15);
      box-shadow: 0 0 15px rgba(240,208,64,0.2);
    }

    .tree-node .icon {
      margin-right: 0.8rem;
      font-size: 1.1rem;
    }

    .nested {
      margin-left: 2rem;
      margin-top: 0.6rem;
    }

    .suggestion {
      padding: 1.4rem;
      margin-bottom: 1.2rem;
      background: rgba(0,224,255,0.1);
      border-left: 5px solid var(--accent);
      border-radius: 12px;
      line-height: 1.6;
      font-size: 1.05rem;
    }

    .status {
      padding: 1.4rem;
      text-align: center;
      background: rgba(18,18,24,0.95);
      color: var(--muted);
      font-size: 1.05rem;
      border-top: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    @media (max-width: 1300px) {
      .layout { grid-template-columns: 1fr 1fr; }
      .section:nth-child(3) { grid-column: span 2; }
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ETERNIVERSE</h1>
    <p>Master Premium PRO v8.0 ‚Äî Pe≈Çna kreacja hierarchicznych ≈õwiat√≥w</p>
  </header>

  <div class="toolbar">
    <select id="profile-select">
      <option value="wattpad">Wattpad</option>
      <option value="amazon">Amazon</option>
    </select>
    <button id="add-universe" class="gold">+ Nowe Uniwersum</button>
    <button id="add-child" class="primary">+ Dziecko</button>
    <button id="bella-analyze" class="primary">Bella AI</button>
    <button id="export-docx" class="gold">Eksport DOCX</button>
    <button id="start-dictate">Dyktuj</button>
    <button id="stop-dictate" disabled>Stop</button>
  </div>

  <div class="layout">
    <!-- Lewy panel: Struktura + Mapa -->
    <div class="section">
      <h2>Hierarchia Universum</h2>
      <div id="current-path"></div>
      <div class="scrollable" id="structure-tree"></div>

      <h2 style="margin-top:2.5rem;">Mapa Bram</h2>
      <div class="scrollable" id="mapa-grid"></div>
    </div>

    <!-- G≈Ç√≥wny edytor -->
    <div class="section">
      <input type="text" id="element-title" placeholder="Tytu≈Ç elementu...">
      <textarea id="element-content" placeholder="Tu rozwija siƒô Twoje uniwersum..."></textarea>
    </div>

    <!-- Prawy panel: Bella AI -->
    <div class="section">
      <h2>Bella AI Pro</h2>
      <div class="scrollable" id="suggestions">
        <p style="text-align:center; opacity:0.7; padding:3rem 0;">
          Wybierz element i kliknij ‚ÄûBella AI‚Äù<br>
          <small>Analiza dostosowana do poziomu hierarchii</small>
        </p>
      </div>
    </div>
  </div>

  <div class="status" id="status">Eterniverse Master Premium PRO ‚Äî gotowy</div>

  <script>
    'use strict';

    class EterniverseMasterPRO {
      constructor() {
        this.STRUCT_KEY = 'eterniverse_structure_pro_v8';
        this.MAPA_KEY = 'eterniverse_mapa_pro';

        this.structure = this.load(this.STRUCT_KEY, []);
        this.mapa = this.load(this.MAPA_KEY, this.defaultMapa());

        this.currentElement = null;
        this.currentProfile = localStorage.getItem('eterniverse_profile') || 'wattpad';
        this.recognition = null;

        this.init();
      }

      defaultMapa() {
        return [
          { id: 1, name: "BRAMA 1 ‚Äî INTERSEEKER", books: ["INTERSEEKER: Geneza", "INTERSEEKER: Efekt Cienia"] },
          { id: 2, name: "BRAMA 2 ‚Äî ETERSEEKER", books: ["EterSeeker: Kronika Woli", "Interfejs ≈öwiadomo≈õci"] },
          { id: 3, name: "BRAMA 3 ‚Äî OBFITOSEEKER", books: ["ObfitoSeeker ‚Äì Kod Obfito≈õci"] },
          { id: 4, name: "BRAMA 4 ‚Äî THE KNOT", books: ["Kronika SplƒÖtania", "Eterniony Tom I"] },
          { id: 5, name: "BRAMA 5 ‚Äî RELIGIOSEEKER", books: ["ReligioSeeker"] }
        ];
      }

      load(key, fallback) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : fallback;
        } catch (e) {
          console.error('B≈ÇƒÖd ≈Çadowania:', e);
          return fallback;
        }
      }

      save(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.error('B≈ÇƒÖd zapisu:', e);
        }
      }

      init() {
        this.updateProfile();
        this.bindEvents();
        this.renderAll();
        this.initSpeech();
        this.status('Eterniverse Master Premium PRO uruchomiony');
      }

      updateProfile() {
        const select = document.getElementById('profile-select');
        if (select) select.value = this.currentProfile;
      }

      bindEvents() {
        document.getElementById('profile-select').onchange = e => {
          this.currentProfile = e.target.value;
          localStorage.setItem('eterniverse_profile', this.currentProfile);
        };

        document.getElementById('add-universe').onclick = () => this.addRootUniverse();
        document.getElementById('add-child').onclick = () => this.addChild();
        document.getElementById('bella-analyze').onclick = () => this.bellaAnalyze();
        document.getElementById('export-docx').onclick = () => this.exportDocx();
        document.getElementById('start-dictate').onclick = () => this.startDictation();
        document.getElementById('stop-dictate').onclick = () => this.stopDictation();

        document.getElementById('element-title').oninput = () => this.autoSave();
        document.getElementById('element-content').oninput = () => this.autoSave();
      }

      renderAll() {
        this.renderStructure();
        this.renderMapa();
        this.renderSuggestions([]);
        this.updateCurrentPath();
      }

      // === STRUKTURA ===
      renderStructure() {
        const container = document.getElementById('structure-tree');
        container.innerHTML = this.structure.length ? this.structure.map(root => this.buildNode(root)).join('')
          : '<p style="opacity:0.6;text-align:center;padding:2rem;">Kliknij ‚Äû+ Nowe Uniwersum‚Äù, by zaczƒÖƒá</p>';
      }

      buildNode(node, depth = 0) {
        const icon = {
          'Uniwersum': 'üåå', '≈öwiat': 'üåç', 'Tom': 'üìö',
          'Rozdzia≈Ç': 'üìñ', 'Podrozdzia≈Ç': 'üìÑ', 'Fragment': 'üìú'
        }[node.type] || 'üìÑ';

        const selected = this.currentElement && this.currentElement.id === node.id;

        return `
          <div class="tree-node \( {selected ? 'selected' : ''}" onclick="master.selectElement(' \){node.id}')">
            <span class="icon">${icon}</span>
            <strong>${this.escape(node.title || '(Bez tytu≈Çu)')}</strong>
            <small style="margin-left:8px;opacity:0.7;">${node.type || ''}</small>
            \( {node.children?.length ? `<div class="nested"> \){node.children.map(child => this.buildNode(child, depth + 1)).join('')}</div>` : ''}
          </div>
        `;
      }

      selectElement(id) {
        this.currentElement = this.findById(id);
        if (this.currentElement) {
          document.getElementById('element-title').value = this.currentElement.title || '';
          document.getElementById('element-content').value = this.currentElement.content || '';
          this.renderStructure();
          this.updateCurrentPath();
        }
      }

      findById(id, nodes = this.structure) {
        for (const node of nodes) {
          if (node.id === id) return node;
          if (node.children?.length) {
            const found = this.findById(id, node.children);
            if (found) return found;
          }
        }
        return null;
      }

      getPathTo(element) {
        const path = [];
        const search = (nodes) => {
          for (const node of nodes) {
            if (node.id === element.id) {
              path.unshift(node);
              return true;
            }
            if (node.children?.length && search(node.children)) {
              path.unshift(node);
              return true;
            }
          }
          return false;
        };
        search(this.structure);
        return path;
      }

      updateCurrentPath() {
        const pathEl = document.getElementById('current-path');
        if (!this.currentElement) {
          pathEl.textContent = '';
          return;
        }

        const path = this.getPathTo(this.currentElement);
        pathEl.textContent = path.map(n => n.title || n.type).join(' ‚Üí ');
      }

      addRootUniverse() {
        const newUniv = {
          id: this.generateId(),
          type: 'Uniwersum',
          title: 'Nowe Uniwersum',
          content: '',
          children: []
        };
        this.structure.push(newUniv);
        this.save(this.STRUCT_KEY, this.structure);
        this.renderStructure();
        this.selectElement(newUniv.id);
        this.status('Nowe uniwersum utworzone');
      }

      addChild() {
        if (!this.currentElement) {
          alert('Wybierz element nadrzƒôdny');
          return;
        }

        const types = ['Uniwersum', '≈öwiat', 'Tom', 'Rozdzia≈Ç', 'Podrozdzia≈Ç', 'Fragment'];
        const currentIdx = types.indexOf(this.currentElement.type || 'Fragment');
        const childType = types[currentIdx + 1] || 'Fragment';

        const newChild = {
          id: this.generateId(),
          type: childType,
          title: `Nowy ${childType}`,
          content: '',
          children: []
        };

        this.currentElement.children = this.currentElement.children || [];
        this.currentElement.children.push(newChild);
        this.save(this.STRUCT_KEY, this.structure);
        this.renderStructure();
        this.selectElement(newChild.id);
        this.status(`Dodano: ${childType}`);
      }

      autoSave() {
        if (!this.currentElement) return;

        this.currentElement.title = document.getElementById('element-title').value;
        this.currentElement.content = document.getElementById('element-content').value;

        this.save(this.STRUCT_KEY, this.structure);
      }

      // === MAPA BRAM ===
      renderMapa() {
        const container = document.getElementById('mapa-grid');
        container.innerHTML = this.mapa.map(brama => `
          <div class="tree-node" onclick="master.insertBrama(${brama.id})">
            <span class="icon">üîÆ</span>
            <strong>${this.escape(brama.name)}</strong>
            <small style="margin-left:8px;opacity:0.7;">${brama.books?.length || 0} tytu≈Ç√≥w</small>
          </div>
        `).join('');
      }

      insertBrama(id) {
        const brama = this.mapa.find(b => b.id === id);
        if (!this.currentElement || !brama) return;

        const list = brama.books?.map(t => `‚Ä¢ ${t}`).join('\n') || '';
        const textarea = document.getElementById('element-content');
        textarea.value += `\n\n‚ú¶ === \( {brama.name} === ‚ú¶\n \){list}\n\n`;
        this.autoSave();
        this.status(`Wstawiono bramƒô: ${brama.name}`);
      }

      // === BELLA AI PRO ===
      bellaAnalyze() {
        if (!this.currentElement || !this.currentElement.content?.trim()) {
          this.status('Brak tre≈õci do analizy');
          return;
        }

        const suggestions = this.generateProSuggestions(this.currentElement);
        this.renderSuggestions(suggestions);
        this.status(`${suggestions.length} profesjonalnych sugestii`);
      }

      generateProSuggestions(element) {
        const text = element.content || '';
        const lower = text.toLowerCase();
        const type = element.type || 'Fragment';
        const suggestions = [];

        // Sugestie zale≈ºne od poziomu w hierarchii
        if (type === 'Uniwersum' || type === '≈öwiat') {
          if (text.length < 200) suggestions.push('Opisz fundamenty ≈õwiata: prawa fizyki, magia, historia');
          if (!lower.includes('geografia') && !lower.includes('mapa')) suggestions.push('Dodaj opis geografii i kluczowych lokacji');
        }

        if (type === 'Tom' || type === 'Rozdzia≈Ç') {
          if (!text.match(/["‚Äû‚Äù]/)) suggestions.push('Wprowad≈∫ dialogi ‚Äì o≈ºywiajƒÖ postaci');
          if (!lower.includes('konflikt') && !lower.includes('cel')) suggestions.push('Wyra≈∫nie zdefiniuj g≈Ç√≥wny konflikt lub cel bohatera');
        }

        // Profilowe
        if (this.currentProfile === 'amazon') {
          if (!/limitowan|wy≈ÇƒÖczn|specjaln/i.test(lower)) suggestions.push('Podkre≈õl unikalno≈õƒá: ‚Äûedycja limitowana‚Äù, ‚Äûtylko tutaj‚Äù');
        } else {
          const emotions = (lower.match(/(strach|mi≈Ço≈õƒá|rado≈õƒá|smutek|gniew|zaskoczenie|nadzieja)/g) || []).length;
          if (