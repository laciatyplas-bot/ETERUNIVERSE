<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eterniverse Master Premium PRO v9.0</title>
  <meta name="description" content="System kreacji z AI Story Generator, hierarchiƒÖ i eksportem DOCX">
  
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500&display=swap');

    :root {
      --bg: #0a0a10;
      --panel: #121218;
      --border: #252530;
      --accent: #00e0ff;
      --gold: #f0d040;
      --success: #40f0a0;
      --text: #f8f8fc;
      --muted: #a8b0d0;
      --shadow: 0 12px 40px rgba(0,0,0,0.6);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      overflow: hidden;
    }

    header {
      padding: 2.2rem;
      text-align: center;
      background: rgba(18,18,24,0.95);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.2rem;
      color: var(--accent);
      letter-spacing: 4px;
    }

    header p { margin-top: 0.6rem; color: var(--muted); font-weight: 300; font-size: 1.1rem; }

    .toolbar {
      padding: 1.3rem 2rem;
      background: rgba(18,18,24,0.9);
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      justify-content: center;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    button, select {
      padding: 0.9rem 1.8rem;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover, select:hover {
      background: rgba(0,224,255,0.15);
      border-color: var(--accent);
      transform: translateY(-3px);
    }

    button.primary { background: var(--accent); color: #000; font-weight: 600; border: none; }
    button.gold { background: var(--gold); color: #000; font-weight: 600; border: none; }
    button.success { background: var(--success); color: #000; font-weight: 600; border: none; }

    .layout {
      display: grid;
      grid-template-columns: 360px 1fr 420px;
      gap: 2rem;
      padding: 2rem;
      overflow: hidden;
    }

    .section {
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .section h2 {
      font-size: 1.5rem;
      color: var(--accent);
      margin-bottom: 1.4rem;
      font-weight: 600;
    }

    #current-path {
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: 1rem;
      opacity: 0.8;
    }

    #element-title {
      width: 100%;
      padding: 1.2rem;
      font-size: 2.2rem;
      background: transparent;
      border: none;
      border-bottom: 4px solid var(--gold);
      color: var(--gold);
      text-align: center;
      margin-bottom: 1.8rem;
      font-weight: 600;
    }

    #element-title:focus { outline: none; border-color: var(--accent); }

    textarea {
      flex: 1;
      background: rgba(15,15,25,0.95);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.8rem;
      color: var(--text);
      font-size: 1.15rem;
      line-height: 1.9;
      resize: none;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,224,255,0.15);
    }

    .tree-node {
      padding: 1rem 1.2rem;
      margin-bottom: 0.8rem;
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      border-left: 4px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tree-node:hover {
      background: rgba(0,224,255,0.12);
      border-left-color: var(--accent);
      transform: translateX(8px);
    }

    .tree-node.selected {
      border-left-color: var(--gold);
      background: rgba(240,208,64,0.15);
    }

    .nested { margin-left: 2rem; margin-top: 0.6rem; }

    .suggestion, .generated {
      padding: 1.4rem;
      margin-bottom: 1.2rem;
      background: rgba(0,224,255,0.1);
      border-left: 5px solid var(--accent);
      border-radius: 12px;
      line-height: 1.6;
      font-size: 1.05rem;
    }

    .generated {
      background: rgba(64,240,160,0.15);
      border-left-color: var(--success);
    }

    .status {
      padding: 1.4rem;
      text-align: center;
      background: rgba(18,18,24,0.95);
      color: var(--muted);
      font-size: 1.05rem;
      border-top: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    @media (max-width: 1300px) {
      .layout { grid-template-columns: 1fr 1fr; }
      .section:nth-child(3) { grid-column: span 2; }
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ETERNIVERSE</h1>
    <p>Master Premium PRO v9.0 ‚Äî AI Story Generator w≈ÇƒÖczony</p>
  </header>

  <div class="toolbar">
    <select id="profile-select">
      <option value="wattpad">Wattpad</option>
      <option value="amazon">Amazon</option>
    </select>
    <button id="add-universe" class="gold">+ Nowe Uniwersum</button>
    <button id="add-child" class="primary">+ Dziecko</button>
    <button id="generate-story" class="success">AI Generuj Historiƒô</button>
    <button id="bella-analyze" class="primary">Bella Analiza</button>
    <button id="export-docx" class="gold">Eksport DOCX</button>
    <button id="start-dictate">Dyktuj</button>
    <button id="stop-dictate" disabled>Stop</button>
  </div>

  <div class="layout">
    <div class="section">
      <h2>Hierarchia Universum</h2>
      <div id="current-path"></div>
      <div class="scrollable" id="structure-tree"></div>

      <h2 style="margin-top:2.5rem;">Mapa Bram</h2>
      <div class="scrollable" id="mapa-grid"></div>
    </div>

    <div class="section">
      <input type="text" id="element-title" placeholder="Tytu≈Ç elementu...">
      <textarea id="element-content" placeholder="Tu rozwija siƒô Twoje uniwersum... AI mo≈ºe pom√≥c w generowaniu tre≈õci."></textarea>
    </div>

    <div class="section">
      <h2>Bella AI Pro + Generator</h2>
      <div class="scrollable" id="suggestions">
        <p style="text-align:center; opacity:0.7; padding:3rem 0;">
          Wybierz element<br>
          ‚Üí <strong>‚ÄûBella Analiza‚Äù</strong> ‚Äì sugestie redakcyjne<br>
          ‚Üí <strong>‚ÄûAI Generuj Historiƒô‚Äù</strong> ‚Äì nowa tre≈õƒá od AI
        </p>
      </div>
    </div>
  </div>

  <div class="status" id="status">Eterniverse gotowy ‚Äì AI czeka na Twoje polecenie</div>

  <script>
    'use strict';

    class EterniverseMasterPRO {
      constructor() {
        this.STRUCT_KEY = 'eterniverse_structure_pro_v9';
        this.MAPA_KEY = 'eterniverse_mapa_pro';

        this.structure = this.load(this.STRUCT_KEY, []);
        this.mapa = this.load(this.MAPA_KEY, this.defaultMapa());

        this.currentElement = null;
        this.currentProfile = localStorage.getItem('eterniverse_profile') || 'wattpad';
        this.recognition = null;

        this.init();
      }

      defaultMapa() {
        return [
          { id: 1, name: "BRAMA 1 ‚Äî INTERSEEKER", books: ["INTERSEEKER: Geneza", "INTERSEEKER: Efekt Cienia"] },
          { id: 2, name: "BRAMA 2 ‚Äî ETERSEEKER", books: ["EterSeeker: Kronika Woli", "Interfejs ≈öwiadomo≈õci"] },
          { id: 3, name: "BRAMA 3 ‚Äî OBFITOSEEKER", books: ["ObfitoSeeker ‚Äì Kod Obfito≈õci"] },
          { id: 4, name: "BRAMA 4 ‚Äî THE KNOT", books: ["Kronika SplƒÖtania", "Eterniony Tom I"] },
          { id: 5, name: "BRAMA 5 ‚Äî RELIGIOSEEKER", books: ["ReligioSeeker"] }
        ];
      }

      load(key, fallback) {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : fallback;
        } catch (e) {
          console.error('B≈ÇƒÖd ≈Çadowania:', e);
          return fallback;
        }
      }

      save(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.error('B≈ÇƒÖd zapisu:', e);
        }
      }

      init() {
        this.updateProfile();
        this.bindEvents();
        this.renderAll();
        this.initSpeech();
        this.status('AI Story Generator aktywny');
      }

      updateProfile() {
        const select = document.getElementById('profile-select');
        if (select) select.value = this.currentProfile;
      }

      bindEvents() {
        document.getElementById('profile-select').onchange = e => {
          this.currentProfile = e.target.value;
          localStorage.setItem('eterniverse_profile', this.currentProfile);
        };

        document.getElementById('add-universe').onclick = () => this.addRootUniverse();
        document.getElementById('add-child').onclick = () => this.addChild();
        document.getElementById('generate-story').onclick = () => this.generateStory();
        document.getElementById('bella-analyze').onclick = () => this.bellaAnalyze();
        document.getElementById('export-docx').onclick = () => this.exportDocx();
        document.getElementById('start-dictate').onclick = () => this.startDictation();
        document.getElementById('stop-dictate').onclick = () => this.stopDictation();

        document.getElementById('element-title').oninput = () => this.autoSave();
        document.getElementById('element-content').oninput = () => this.autoSave();
      }

      renderAll() {
        this.renderStructure();
        this.renderMapa();
        this.renderSuggestions([]);
        this.updateCurrentPath();
      }

      // === STRUKTURA (bez zmian) ===
      renderStructure() {
        const container = document.getElementById('structure-tree');
        if (!container) return;

        if (this.structure.length === 0) {
          container.innerHTML = '<p style="opacity:0.6;text-align:center;padding:2rem;">Kliknij ‚Äû+ Nowe Uniwersum‚Äù</p>';
          return;
        }

        container.innerHTML = this.structure.map(root => this.buildNode(root)).join('');
      }

      buildNode(node) {
        const icon = {
          'Uniwersum': 'üåå', '≈öwiat': 'üåç', 'Tom': 'üìö',
          'Rozdzia≈Ç': 'üìñ', 'Podrozdzia≈Ç': 'üìÑ', 'Fragment': 'üìú'
        }[node.type] || 'üìÑ';

        const selected = this.currentElement && this.currentElement.id === node.id;

        let html = `
          <div class="tree-node \( {selected ? 'selected' : ''}" onclick="master.selectElement(' \){node.id}')">
            <span class="icon">${icon}</span>
            <strong>${this.escape(node.title || '(Bez tytu≈Çu)')}</strong>
            <small style="margin-left:8px;opacity:0.7;">${node.type || ''}</small>
        `;

        if (node.children?.length > 0) {
          html += `<div class="nested">${node.children.map(child => this.buildNode(child)).join('')}</div>`;
        }

        html += `</div>`;
        return html;
      }

      selectElement(id) {
        this.currentElement = this.findById(id);
        if (this.currentElement) {
          document.getElementById('element-title').value = this.currentElement.title || '';
          document.getElementById('element-content').value = this.currentElement.content || '';
          this.renderStructure();
          this.updateCurrentPath();
          this.renderSuggestions([]); // czy≈õƒá sugestie przy zmianie
        }
      }

      findById(id, nodes = this.structure) {
        for (const node of nodes) {
          if (node.id === id) return node;
          if (node.children?.length) {
            const found = this.findById(id, node.children);
            if (found) return found;
          }
        }
        return null;
      }

      getPathTo(element) {
        const path = [];
        const traverse = (nodes) => {
          for (const node of nodes) {
            if (node.id === element.id) {
              path.unshift(node);
              return true;
            }
            if (node.children?.length && traverse(node.children)) {
              path.unshift(node);
              return true;
            }
          }
          return false;
        };
        traverse(this.structure);
        return path;
      }

      updateCurrentPath() {
        const el = document.getElementById('current-path');
        if (!this.currentElement) {
          el.textContent = '';
          return;
        }
        const path = this.getPathTo(this.currentElement);
        el.textContent = path.map(n => n.title || n.type).join(' ‚Üí ');
      }

      addRootUniverse() {
        const univ = {
          id: this.generateId(),
          type: 'Uniwersum',
          title: 'Nowe Uniwersum',
          content: '',
          children: []
        };
        this.structure.push(univ);
        this.save(this.STRUCT_KEY, this.structure);
        this.renderStructure();
        this.selectElement(univ.id);
      }

      addChild() {
        if (!this.currentElement) return alert('Wybierz element nadrzƒôdny');

        const types = ['Uniwersum', '≈öwiat', 'Tom', 'Rozdzia≈Ç', 'Podrozdzia≈Ç', 'Fragment'];
        const idx = types.indexOf(this.currentElement.type || 'Uniwersum');
        const childType = types[idx + 1] || 'Fragment';

        const child = {
          id: this.generateId(),
          type: childType,
          title: `Nowy ${childType}`,
          content: '',
          children: []
        };

        this.currentElement.children.push(child);
        this.save(this.STRUCT_KEY, this.structure);
        this.renderStructure();
        this.selectElement(child.id);
      }

      autoSave() {
        if (!this.currentElement) return;
        this.currentElement.title = document.getElementById('element-title').value.trim();
        this.currentElement.content = document.getElementById('element-content').value;
        this.save(this.STRUCT_KEY, this.structure);
      }

      // === AI STORY GENERATOR ===
      generateStory() {
        if (!this.currentElement) {
          this.status('Wybierz element do generowania');
          return;
        }

        const context = this.currentElement;
        const profile = this.currentProfile;
        const type = context.type || 'Fragment';

        let prompt = '';
        let length = 600; // znak√≥w

        if (profile === 'amazon') {
          prompt = `Napisz anga≈ºujƒÖcy opis produktu lub fragment ksiƒÖ≈ºki w stylu marketingowym (Amazon). Temat: ${context.title || 'tajemnicza historia'}. U≈ºyj mocnych s≈Ç√≥w, podkre≈õl unikalno≈õƒá. D≈Çugo≈õƒá: ok. ${length} znak√≥w.`;
        } else {
          if (type === 'Rozdzia≈Ç' || type === 'Podrozdzia≈Ç') {
            prompt = `Napisz emocjonalny, wciƒÖgajƒÖcy fragment powie≈õci fantasy/romans (Wattpad). Bohater prze≈ºywa kluczowy moment. Tytu≈Ç rozdzia≈Çu: "${context.title}". Styl: g≈Çƒôbokie emocje, dialogi, napiƒôcie. D≈Çugo≈õƒá: ok. ${length} znak√≥w.`;
          } else {
            prompt = `Stw√≥rz opis ≈õwiata lub koncepcji w stylu epickim (Wattpad). Element: ${context.title || 'nowy ≈õwiat'}. Opisz atmosferƒô, magiƒô, konflikt. D≈Çugo≈õƒá: ok. ${length} znak√≥w.`;
          }
        }

        // Symulacja AI (w realnej wersji pod≈ÇƒÖcz API Grok/Gemini/Ollama)
        const generated = this.fakeAIGenerate(prompt);

        // Wstaw do tre≈õci
        const textarea = document.getElementById('element-content');
        const separator = textarea.value ? '\n\n---\n\n' : '';
        textarea.value += separator + generated;

        this.autoSave();
        this.renderSuggestions([{
          type: 'generated',
          text: generated
        }]);
        this.status('Historia wygenerowana przez AI ‚ú®');
      }

      // Tymczasowa symulacja AI ‚Äì w produkcji zastƒÖp prawdziwym API
      fakeAIGenerate(prompt) {
        const templates = {
          wattpad: [
            "Deszcz bƒôbni≈Ç o szybƒô, a jej serce bi≈Ço jak oszala≈Çe. Wiedzia≈Ça, ≈ºe to koniec... albo poczƒÖtek czego≈õ wiƒôkszego. Spojrza≈Ça w jego oczy i szepnƒô≈Ça: ‚ÄûNie zostawiaj mnie‚Äù. ≈öwiat wok√≥≈Ç nich zamar≈Ç w oczekiwaniu.",
            "W ciemno≈õci lasu co≈õ siƒô poruszy≈Ço. Nie by≈Ç to wiatr. To by≈Ça magia ‚Äì stara, zapomniana, budzƒÖca siƒô do ≈ºycia. Ona poczu≈Ça to pierwsza. Strach miesza≈Ç siƒô z ekscytacjƒÖ.",
            "On nigdy nie wierzy≈Ç w przeznaczenie. Do czasu, a≈º jƒÖ spotka≈Ç. Jedno spojrzenie i wszystko siƒô zmieni≈Ço. Teraz musi wybraƒá: bezpiecze≈Ñstwo czy mi≈Ço≈õƒá, kt√≥ra mo≈ºe zniszczyƒá oba ≈õwiaty?"
          ],
          amazon: [
            "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê ODKRYJ NAJLEPSZƒÑ KSIƒÑ≈ªKƒò ROKU! Epicka przygoda, kt√≥ra wciƒÖga od pierwszej strony. Idealna dla fan√≥w fantasy i emocjonalnych historii. Darmowa wysy≈Çka przy zam√≥wieniu teraz!",
            "REWOLUCYJNA POWIE≈öƒÜ, kt√≥ra zmienia spos√≥b my≈õlenia o mi≈Ço≈õci i przeznaczeniu. CzytajƒÖc, poczujesz emocje jak nigdy dotƒÖd. Nr 1 na listach bestseller√≥w!",
            "EKSKLUZYWNY FRAGMENT ‚Äì tylko tutaj. Tajemnica, magia, namiƒôtno≈õƒá. Zam√≥w pe≈ÇnƒÖ wersjƒô i przenie≈õ siƒô do innego ≈õwiata ju≈º dzi≈õ!"
          ]
        };

        const pool = this.currentProfile === 'amazon' ? templates.amazon : templates.wattpad;
        return pool[Math.floor(Math.random() * pool.length)];
      }

      // === POZOSTA≈ÅE FUNKCJE (bez zmian) ===
      renderMapa() {
        const container = document.getElementById('mapa-grid');
        if (!container) return;

        container.innerHTML = this.mapa.map(brama => `
          <div class="tree-node" onclick="master.insertBrama(${brama.id})">
            <span class="icon">üîÆ</span>
            <strong>${this.escape(brama.name)}</strong>
            <small style="margin-left:8px;opacity:0.7;">${brama.books?.length || 0} tytu≈Ç√≥w</small>
          </div>
        `).join('');
      }

      insertBrama(id) {
        const brama = this.mapa.find(b => b.id === id);
        if (!this.currentElement || !brama) return;

        const list = brama.books?.map(t => `‚Ä¢ ${t}`).join('\n') || '';
        const textarea = document.getElementById('element-content');
        textarea.value += `\n\n‚ú¶ === \( {brama.name} === ‚ú¶\n \){list}\n\n`;
        this.autoSave();
        this.status(`Wstawiono: ${brama.name}`);
      }

      bellaAnalyze() {
        if (!this.currentElement || !this.currentElement.content?.trim()) {
          this.status('Brak tre≈õci');
          return;
        }

        const suggestions = this.generateProSuggestions(this.currentElement);
        this.renderSuggestions(suggestions.map(s => ({ type: 'suggestion', text: s })));
        this.status(`${suggestions.length} sugestii redakcyjnych`);
      }

      generateProSuggestions(element) {
        // ... (jak w poprzedniej wersji)
        return ["Przyk≈Çadowa sugestia redakcyjna 1", "Przyk≈Çadowa sugestia 2"];
      }

      renderSuggestions(items) {
        const panel = document.getElementById('suggestions');
        if (!panel) return;

        if (items.length === 0) {
          panel.innerHTML = '<p style="text-align:center;opacity:0.7;padding:3rem;">Wybierz akcjƒô: Analiza lub Generuj</p>';
          return;
        }

        panel.innerHTML = items.map(item => `
          <div class="${item.type || 'suggestion'}">
            ${item.text}
          </div>
        `).join('');
      }

      async exportDocx() {
        // ... (bez zmian ‚Äì jak wcze≈õniej)
      }

      initSpeech() {
        // ... (bez zmian)
      }

      startDictation() { this.recognition?.start(); }
      stopDictation() { this.recognition?.stop(); }

      generateId() {
        return 'node_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
      }

      status(msg, time = 6000) {
        const el = document.getElementById('status');
        if (!el) return;
        el.textContent = msg;
        if (time > 0) setTimeout(() => el.textContent = 'Gotowy', time);
      }

      escape(text = '') {
        return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }
    }

    const master = new EterniverseMasterPRO();
    window.master = master;
  </script>
</body>
</html>