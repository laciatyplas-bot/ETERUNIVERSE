<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eterniverse Master Premium v6.0</title>
  <meta name="description" content="Kompletny system pisarski: ksiƒÖ≈ºki, Bella AI, struktura universum, mapa bram, eksport DOCX">
  
  <!-- DOCX Export -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500&display=swap');

    :root {
      --bg: #0d0d12;
      --panel: #14141a;
      --border: #282833;
      --accent: #00d0ff;
      --gold: #f0c040;
      --text: #f5f5fa;
      --muted: #a0a8c0;
      --shadow: 0 12px 40px rgba(0,0,0,0.5);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      overflow: hidden;
    }

    header {
      padding: 2rem;
      text-align: center;
      background: rgba(20,20,26,0.9);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3rem;
      color: var(--accent);
      letter-spacing: 3px;
    }

    header p { margin-top: 0.5rem; color: var(--muted); font-weight: 300; }

    .toolbar {
      padding: 1.2rem 2rem;
      background: rgba(20,20,26,0.8);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      border-bottom: 1px solid var(--border);
    }

    button, select {
      padding: 0.8rem 1.6rem;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-weight: 500;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover, select:hover { background: rgba(0,208,255,0.15); border-color: var(--accent); }

    button.primary { background: var(--accent); color: #000; font-weight: 600; border: none; }
    button.gold { background: var(--gold); color: #000; font-weight: 600; border: none; }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr 380px;
      gap: 1.8rem;
      padding: 2rem;
      overflow: hidden;
    }

    .section {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 1.8rem;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
      overflow-y: auto;
    }

    .section h2 {
      font-size: 1.4rem;
      color: var(--accent);
      margin-bottom: 1.2rem;
      font-weight: 600;
    }

    #book-title {
      width: 100%;
      padding: 1rem;
      font-size: 2rem;
      background: transparent;
      border: none;
      border-bottom: 3px solid var(--gold);
      color: var(--gold);
      text-align: center;
      margin-bottom: 1.5rem;
      font-weight: 600;
    }

    #book-title:focus { outline: none; border-color: var(--accent); }

    textarea {
      flex: 1;
      background: rgba(15,15,25,0.9);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.6rem;
      color: var(--text);
      font-size: 1.1rem;
      line-height: 1.8;
      resize: none;
    }

    textarea:focus { outline: none; border-color: var(--accent); }

    .item {
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      border-left: 3px solid var(--border);
      cursor: pointer;
      transition: 0.3s;
    }

    .item:hover { background: rgba(0,208,255,0.1); border-left-color: var(--accent); transform: translateX(6px); }
    .active { border-left-color: var(--gold); background: rgba(240,192,64,0.1); }

    .suggestion {
      padding: 1.2rem;
      margin-bottom: 1rem;
      background: rgba(0,208,255,0.08);
      border-left: 4px solid var(--accent);
      border-radius: 10px;
      line-height: 1.5;
    }

    .nested { margin-left: 1.5rem; }

    .status {
      padding: 1.2rem;
      text-align: center;
      background: rgba(20,20,26,0.9);
      color: var(--muted);
      font-size: 1rem;
      border-top: 1px solid var(--border);
    }

    @media (max-width: 1200px) {
      .layout { grid-template-columns: 1fr; }
      .section { min-height: 300px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ETERNIVERSE</h1>
    <p>Master Premium v6.0 ‚Äî Kompletny system kreacji literackiej</p>
  </header>

  <div class="toolbar">
    <select id="profile-select">
      <option value="wattpad">Wattpad</option>
      <option value="amazon">Amazon</option>
    </select>
    <button id="add-book-btn" class="gold">+ Nowa Ksiƒôga</button>
    <button id="add-universe" class="primary">+ Nowe Uniwersum</button>
    <button id="bella-analyze" class="primary">Bella AI</button>
    <button id="export-docx" class="gold">Eksport DOCX</button>
    <button id="start-dictate">Dyktuj</button>
    <button id="stop-dictate" disabled>Stop</button>
  </div>

  <div class="layout">
    <!-- Lewy panel: KsiƒÖ≈ºki + Struktura + Mapa -->
    <div class="section">
      <h2>Ksiƒôgi</h2>
      <div id="books-list"></div>

      <h2 style="margin-top:2rem;">Struktura Universum</h2>
      <div id="structure-tree"></div>

      <h2 style="margin-top:2rem;">Mapa Bram</h2>
      <div id="mapa-grid"></div>
    </div>

    <!-- Edytor -->
    <div class="section">
      <input type="text" id="book-title" placeholder="Tytu≈Ç ksiƒôgi...">
      <textarea id="book-content" placeholder="Tu tworzysz swoje ≈õwiaty..."></textarea>
    </div>

    <!-- Bella AI -->
    <div class="section">
      <h2>Bella AI</h2>
      <div id="suggestions">
        <p style="text-align:center; opacity:0.7; padding:2rem 0;">
          Wybierz ksiƒôgƒô i kliknij ‚ÄûBella AI‚Äù
        </p>
      </div>
    </div>
  </div>

  <div class="status" id="status">System gotowy</div>

  <script>
    'use strict';

    class EterniverseMaster {
      constructor() {
        this.BOOKS_KEY = 'eterniverse_books_v6';
        this.STRUCT_KEY = 'eterniverse_structure_v6';
        this.MAPA_KEY = 'eterniverse_mapa_v6';

        this.books = this.load('BOOKS_KEY', []);
        this.structure = this.load('STRUCT_KEY', []);
        this.mapa = this.load('MAPA_KEY', []);
        
        this.currentBook = null;
        this.currentProfile = 'wattpad';
        this.recognition = null;

        this.init();
      }

      load(key, fallback) {
        try { return JSON.parse(localStorage.getItem(this[key]) || JSON.stringify(fallback)); }
        catch { return fallback; }
      }

      save(key, data) { localStorage.setItem(this[key], JSON.stringify(data)); }

      init() {
        this.bindEvents();
        this.renderAll();
        this.initSpeech();
      }

      bindEvents() {
        document.getElementById('profile-select').onchange = e => this.currentProfile = e.target.value;
        document.getElementById('add-book-btn').onclick = () => this.addBook();
        document.getElementById('add-universe').onclick = () => this.addUniverse();
        document.getElementById('bella-analyze').onclick = () => this.bellaAnalyze();
        document.getElementById('export-docx').onclick = () => this.exportDocx();
        document.getElementById('start-dictate').onclick = () => this.startDictation();
        document.getElementById('stop-dictate').onclick = () => this.stopDictation();

        document.getElementById('book-title').oninput = () => this.autoSave();
        document.getElementById('book-content').oninput = () => this.autoSave();
      }

      renderAll() {
        this.renderBooks();
        this.renderStructure();
        this.renderMapa();
      }

      // === KSIƒÑ≈ªKI ===
      renderBooks() {
        const list = document.getElementById('books-list');
        list.innerHTML = this.books.length ? this.books.map(b => `
          <div class="item \( {this.currentBook?.id === b.id ? 'active' : ''}" onclick="master.openBook( \){b.id})">
            <strong>üìñ ${this.escape(b.title || 'Bez tytu≈Çu')}</strong>
            <div style="font-size:0.9rem;opacity:0.8;margin-top:0.4rem;">
              ${this.wordCount(b.content)} s≈Ç√≥w
            </div>
          </div>
        `).join('') : '<p style="opacity:0.6;text-align:center;padding:2rem;">Utw√≥rz pierwszƒÖ ksiƒôgƒô</p>';
      }

      addBook() {
        const book = { id: Date.now(), title: 'Nowa Ksiƒôga', content: '', created: Date.now() };
        this.books.unshift(book);
        this.save('BOOKS_KEY', this.books);
        this.openBook(book.id);
        this.status('Nowa ksiƒôga utworzona');
      }

      openBook(id) {
        this.currentBook = this.books.find(b => b.id === id);
        document.getElementById('book-title').value = this.currentBook.title;
        document.getElementById('book-content').value = this.currentBook.content || '';
        this.renderBooks();
      }

      autoSave() {
        if (!this.currentBook) return;
        this.currentBook.title = document.getElementById('book-title').value;
        this.currentBook.content = document.getElementById('book-content').value;
        this.save('BOOKS_KEY', this.books);
      }

      // === STRUKTURA ===
      renderStructure() {
        const tree = document.getElementById('structure-tree');
        tree.innerHTML = this.structure.length ? this.structure.map(item => this.buildNode(item)).join('') 
          : '<p style="opacity:0.6;text-align:center;padding:1rem;">Brak uniwers√≥w</p>';
      }

      buildNode(item) {
        return `
          <div class="item" onclick="master.selectStruct(${item.id})">
            ${this.getIcon(item.type || 'Uniwersum')} ${this.escape(item.title)}
            \( {item.children?.length ? `<div class="nested"> \){item.children.map(c => this.buildNode(c)).join('')}</div>` : ''}
          </div>
        `;
      }

      addUniverse() {
        const univ = { id: Date.now(), type: 'Uniwersum', title: 'Nowe Uniwersum', children: [] };
        this.structure.push(univ);
        this.save('STRUCT_KEY', this.structure);
        this.renderStructure();
      }

      selectStruct(id) { /* mo≈ºna rozbudowaƒá w przysz≈Ço≈õci */ }

      // === MAPA BRAM ===
      renderMapa() {
        const grid = document.getElementById('mapa-grid');
        grid.innerHTML = this.mapa.length ? this.mapa.map(brama => `
          <div class="item" onclick="master.insertBrama(${brama.id})">
            <strong>üîÆ ${this.escape(brama.name)}</strong>
            <div style="font-size:0.9rem;opacity:0.8;">${brama.books?.length || 0} ksiƒÖg</div>
          </div>
        `).join('') : '<p style="opacity:0.6;text-align:center;padding:1rem;">Brak bram</p>';
      }

      insertBrama(id) {
        const brama = this.mapa.find(b => b.id === id);
        if (!this.currentBook || !brama) return;
        const list = brama.books?.map(bk => `üìñ ${bk.title}`).join('\n') || '';
        document.getElementById('book-content').value += `\n\n=== \( {brama.name} ===\n \){list}\n`;
        this.autoSave();
      }

      // === BELLA AI ===
      bellaAnalyze() {
        if (!this.currentBook?.content) return this.status('Brak tekstu do analizy');
        const sugs = this.generateSuggestions(this.currentBook.content);
        this.renderSuggestions(sugs);
        this.status(`${sugs.length} sugestii Bella`);
      }

      generateSuggestions(text) {
        const sugs = [];
        const lower = text.toLowerCase();
        const words = this.wordCount(text);

        if (this.currentProfile === 'amazon') {
          if (!/darmowa|wysy≈Çka|gwarancja/i.test(lower)) sugs.push('Dodaj frazy: ‚Äûdarmowa wysy≈Çka‚Äù, ‚Äûgwarancja‚Äù');
          if (!/najlepszy|rewolucyjny|premium/i.test(lower)) sugs.push('U≈ºyj s≈Ç√≥w mocy: najlepszy, rewolucyjny, premium');
        } else {
          if (!/"|‚Äû|‚Äù/.test(text)) sugs.push('Dodaj dialogi ‚Äì zwiƒôkszajƒÖ zaanga≈ºowanie');
          if ((lower.match(/(smut|strach|mi≈Ço≈õƒá|rado≈õƒá|przera≈º)/g) || []).length < 4) sugs.push('Wpleƒá wiƒôcej emocji');
        }

        if (words < 300) sugs.push('Rozwi≈Ñ tekst ‚Äì d≈Çu≈ºsze fragmenty majƒÖ wiƒôkszy zasiƒôg');
        return sugs.slice(0, 7);
      }

      renderSuggestions(sugs) {
        const panel = document.getElementById('suggestions');
        panel.innerHTML = sugs.length ? sugs.map(s => `<div class="suggestion">${s}</div>`).join('')
          : '<p style="text-align:center;opacity:0.7;padding:2rem;">Tekst idealny ‚Äì brak sugestii</p>';
      }

      // === EKSPORT ===
      async exportDocx() {
        if (!this.currentBook) return this.status('Brak ksiƒôgi');
        const { Document, Packer, Paragraph, HeadingLevel } = docx;
        const doc = new Document({
          sections: [{ children: [
            new Paragraph({ text: this.currentBook.title, heading: HeadingLevel.TITLE, alignment: "center" }),
            new Paragraph({ text: `Profil: ${this.currentProfile.toUpperCase()} ‚Ä¢ ${new Date().toLocaleDateString('pl-PL')}`, alignment: "center" }),
            new Paragraph({ text: this.currentBook.content || '' })
          ]}]
        });
        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${this.currentBook.title.replace(/[^a-z0-9]/gi,'_')}_Eterniverse.docx`;
        a.click();
        URL.revokeObjectURL(url);
        this.status('Eksport zako≈Ñczony');
      }

      // === MOWA ===
      initSpeech() {
        if (!('webkitSpeechRecognition' in window)) return;
        this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        this.recognition.lang = 'pl-PL';
        this.recognition.continuous = true;
        this.recognition.interimResults = true;

        this.recognition.onresult = e => {
          const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
          document.getElementById('book-content').value += transcript;
          this.autoSave();
        };

        this.recognition.onstart = () => {
          document.getElementById('start-dictate').disabled = true;
          document.getElementById('stop-dictate').disabled = false;
          this.status('Dyktowanie aktywne');
        };

        this.recognition.onend = () => {
          document.getElementById('start-dictate').disabled = false;
          document.getElementById('stop-dictate').disabled = true;
        };
      }

      startDictation() { this.recognition?.start(); }
      stopDictation() { this.recognition?.stop(); }

      // === POMOCNICZE ===
      status(msg) {
        document.getElementById('status').textContent = msg;
        setTimeout(() => document.getElementById('status').textContent = 'Gotowy', 5000);
      }

      wordCount(text = '') { return (text.match(/\b\w+\b/g) || []).length; }

      escape(text) { return text?.replace(/</g, '&lt;').replace(/>/g, '&gt;') || ''; }

      getIcon(type) {
        const icons = { 'Uniwersum': 'üåå', '≈öwiat': 'üåç', 'Tom': 'üìö' };
        return icons[type] || 'üìÑ';
      }
    }

    const master = new EterniverseMaster();
    window.master = master;
  </script>
</body>
</html>