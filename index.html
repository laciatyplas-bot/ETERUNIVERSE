<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eterniverse - Bella Asystent Redakcyjny</title>
  <style>
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-panel: #222;
      --bg-hover: #333;
      --text-primary: #eee;
      --text-secondary: #bbb;
      --accent: #4a90e2;
      --success: #50c878;
      --warning: #f39c12;
      --danger: #e74c3c;
      --border: #444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', Tahoma, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--bg-secondary);
      padding: 1.5rem;
      text-align: center;
      font-size: 1.6rem;
      font-weight: bold;
      border-bottom: 2px solid var(--border);
    }

    .controls {
      padding: 1rem;
      background: var(--bg-panel);
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    select, button {
      padding: 0.75rem 1.25rem;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    button:hover:not(:disabled) {
      background: var(--accent);
      border-color: var(--accent);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    textarea {
      flex: 1;
      margin: 1rem;
      padding: 1.25rem;
      background: var(--bg-panel);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .output-section {
      padding: 1rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
    }

    .dual-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .panel {
      background: var(--bg-panel);
      padding: 1rem;
      border-radius: 8px;
      min-height: 120px;
    }

    .suggestion {
      background: rgba(74, 144, 226, 0.1);
      border-left: 4px solid var(--accent);
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 6px;
      cursor: pointer;
    }

    .suggestion button {
      margin-left: 1rem;
      padding: 0.5rem 1rem;
      background: var(--success);
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .dual-panel { grid-template-columns: 1fr; }
      .controls { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header>Eterniverse - Bella Asystent Redakcyjny</header>

  <div class="controls">
    <label>Profil:</label>
    <select id="profileSelector">
      <option value="amazon">Amazon</option>
      <option value="wattpad">Wattpad</option>
    </select>
    
    <button id="startRecBtn">üéôÔ∏è Rozpocznij dyktowanie</button>
    <button id="stopRecBtn" disabled>‚èπÔ∏è Zatrzymaj</button>
    <button id="executeBtn">‚ú® Wykonaj / Podpowied≈∫</button>
    <button id="exportBtn">üì§ Eksport DOCX</button>
  </div>

  <div style="flex: 1; display: flex; gap: 1rem; padding: 1rem; overflow: hidden;">
    <textarea id="console" 
              placeholder="Wpisz polecenia: REDAGUJ, PODPOWIED≈π, GENERUJ TEKST, EKSPORTUJ&#10;lub tekst do analizy..."></textarea>
    
    <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
      <textarea id="editor" 
                placeholder="Edytor tekstu - tutaj edytuj i eksportuj..."></textarea>
      
      <div id="suggestions" style="flex: 1; overflow: auto;"></div>
    </div>
  </div>

  <div class="output-section">
    <div class="dual-panel">
      <div class="panel">
        <strong>üìã Status:</strong>
        <div id="output">Bella gotowa do pracy! M√≥w "rozpocznij dyktowanie" lub wpisz polecenie.</div>
      </div>
      <div class="panel">
        <strong>üíæ Historia:</strong>
        <div id="history">Czekam na pierwsze polecenie...</div>
      </div>
    </div>
  </div>

  <!-- DOCX Library -->
  <script src="https://cdn.jsdelivr.net/npm/docx@7.3.0/build/index.min.js"></script>
  
  <!-- APP LOGIC - Poprawiona wersja -->
  <script>
  (async () => {
    const { Document, Packer, Paragraph, HeadingLevel } = docx;

    const STORAGE_KEY = 'eterniverse_assistant_data_profiles';
    let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if (!data.amazon) data.amazon = { acceptedSuggestions: [] };
    if (!data.wattpad) data.wattpad = { acceptedSuggestions: [] };

    // ELEMENTS
    const consoleEl = document.getElementById('console');
    const editorEl = document.getElementById('editor');
    const suggestionsEl = document.getElementById('suggestions');
    const outputEl = document.getElementById('output');
    const historyEl = document.getElementById('history');
    const profileSelector = document.getElementById('profileSelector');
    const startRecBtn = document.getElementById('startRecBtn');
    const stopRecBtn = document.getElementById('stopRecBtn');
    const executeBtn = document.getElementById('executeBtn');
    const exportBtn = document.getElementById('exportBtn');

    let currentProfile = profileSelector.value;
    let recognition;
    let recognizing = false;

    // PROFILE SWITCH
    profileSelector.onchange = () => {
      currentProfile = profileSelector.value;
      clearSuggestions();
      showStatus(`Prze≈ÇƒÖczono na profil: ${currentProfile.toUpperCase()}`);
      speakText(`Prze≈ÇƒÖczono na profil ${currentProfile}`);
    };

    // SPEECH RECOGNITION
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'pl-PL';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        consoleEl.value += (consoleEl.value ? ' ' : '') + transcript;
        speakText(`Rozpoznano: ${transcript}`);
        addHistory(`üéôÔ∏è ${transcript}`);
      };

      recognition.onstart = () => {
        recognizing = true;
        startRecBtn.disabled = true;
        stopRecBtn.disabled = false;
        speakText('Rozpoczƒôto dyktowanie');
      };

      recognition.onend = () => {
        recognizing = false;
        startRecBtn.disabled = false;
        stopRecBtn.disabled = true;
      };
    } else {
      startRecBtn.style.display = 'none';
      stopRecBtn.style.display = 'none';
    }

    // EVENT LISTENERS
    startRecBtn.onclick = () => recognition?.start();
    stopRecBtn.onclick = () => recognition?.stop();
    executeBtn.onclick = () => processConsoleText(consoleEl.value);
    exportBtn.onclick = exportCurrent;

    // TTS
    function speakText(text) {
      if (!window.speechSynthesis) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'pl-PL';
      utterance.rate = 0.9;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    // UI HELPERS
    function showStatus(msg) {
      outputEl.textContent = msg;
      addHistory(`üìã ${msg}`);
    }

    function clearSuggestions() {
      suggestionsEl.innerHTML = '';
    }

    function addHistory(msg) {
      const time = new Date().toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
      historyEl.innerHTML += `<div style="font-size:0.9em;opacity:0.8;margin:0.25rem 0;">[${time}] ${msg}</div>`;
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    // AMAZON SUGGESTIONS
    function amazonSuggestions(text) {
      const suggestions = [];
      const words = text.toLowerCase().match(/\bw+\b/g) || [];
      const wordCounts = {};
      
      words.forEach(w => wordCounts[w] = (wordCounts[w] || 0) + 1);
      Object.entries(wordCounts).forEach(([word, count]) => {
        if (count > 5) suggestions.push(`‚ö†Ô∏è "${word}" x${count} - u≈ºyj synonim√≥w`);
      });

      const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
      sentences.forEach((s, i) => {
        const len = s.trim().split(/s+/).length;
        if (len > 25) suggestions.push(`üìè Zdanie ${i+1}: ${len} s≈Ç√≥w - podziel`);
      });

      const seoKeywords = ['darmowa wysy≈Çka', 'gwarancja', 'promocja'];
      seoKeywords.forEach(kw => {
        if (!new RegExp(`\\b${kw}\\b`, 'i').test(text)) {
          suggestions.push(`üîç Dodaj SEO: "${kw}"`);
        }
      });

      return suggestions;
    }

    // WATTPAD SUGGESTIONS
    function wattpadSuggestions(text) {
      const suggestions = [];
      const emotions = ['smutny', 'szczƒô≈õliwy', 'z≈Çy', 'zakocha', 'przera≈º'];
      let emotionCount = emotions.filter(e => new RegExp(`\\b${e}\\b`, 'i').test(text)).length;
      
      if (emotionCount < 2) suggestions.push('‚ù§Ô∏è Wiƒôcej emocji dla Wattpad!');
      
      if (!/[‚Äû‚Äù"']/.test(text)) suggestions.push('üí¨ Dodaj dialogi!');
      
      const shortSentences = text.match(/[^.!?]+[.!?]+/g)?.filter(s => 
        s.trim().split(/s+/).length < 4
      ) || [];
      if (shortSentences.length > 2) {
        suggestions.push(`üìù ${shortSentences.length} kr√≥tkich zda≈Ñ - rozwi≈Ñ`);
      }

      return suggestions;
    }

    function getSuggestionsForProfile(text) {
      return currentProfile === 'amazon' ? amazonSuggestions(text) : wattpadSuggestions(text);
    }

    // MAIN COMMAND PROCESSOR
    function processConsoleText(input) {
      const cmd = input.trim();
      if (!cmd) return;

      const parts = cmd.split(/s+/);
      const cmdUpper = parts[0].toUpperCase();
      addHistory(`‚å®Ô∏è ${cmd.substring(0, 50)}${cmd.length > 50 ? '...' : ''}`);

      switch(cmdUpper) {
        case 'REDAGUJ':
        case 'REDAGUJ TEKST':
          editorEl.value = consoleEl.value;
          showStatus('‚úÖ Tekst w edytorze - wpisz PODPOWIED≈π');
          break;

        case 'PODPOWIED≈π':
          const text = editorEl.value.trim();
          if (!text) return showStatus('‚ùå Edytor pusty!');
          
          const suggestions = getSuggestionsForProfile(text)
            .filter(s => !data[currentProfile].acceptedSuggestions.includes(s));
          
          clearSuggestions();
          if (!suggestions.length) {
            showStatus('üéâ Brak nowych sugestii - tekst idealny!');
          } else {
            suggestions.forEach(suggestion => {
              const div = document.createElement('div');
              div.className = 'suggestion';
              div.innerHTML = `${suggestion} <button>Akceptuj</button>`;
              div.querySelector('button').onclick = () => {
                data[currentProfile].acceptedSuggestions.push(suggestion);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                div.style.opacity = '0.5';
                div.innerHTML += ' ‚úì';
                speakText('Zaakceptowano');
              };
              suggestionsEl.appendChild(div);
            });
            showStatus(`üí° ${suggestions.length} nowych sugestii`);
            speakText(`${suggestions.length} sugestii`);
          }
          break;

        case 'GENERUJ':
        case 'GENERUJ TEKST':
          editorEl.value = generateSampleText(currentProfile);
          showStatus(`‚ú® Wygenerowano pr√≥bkƒô dla ${currentProfile}`);
          speakText('Przyk≈Çadowy tekst gotowy');
          break;

        case 'EKSPORTUJ':
          exportCurrent();
          break;

        default:
          editorEl.value = input;
          showStatus('üìù Tekst za≈Çadowany do edycji');
      }

      consoleEl.value = '';
    }

    function generateSampleText(profile) {
      return profile === 'amazon' ? 
        `Ten produkt to doskona≈Çy wyb√≥r! ‚úÖ Najwy≈ºsza jako≈õƒá, darmowa wysy≈Çka, gwarancja satysfakcji.` :
        `Deszcz sp≈Çywa≈Ç po szybie, a w jej oczach odbija≈Çy siƒô gwiazdy. "Czy to przeznaczenie?" - szepnƒô≈Ça.`;
    }

    async function exportCurrent() {
      if (!editorEl.value.trim()) return showStatus('‚ùå Nic do eksportu!');

      try {
        const doc = new Document({
          sections: [{
            children: [
              new Paragraph({
                text: `ETERNIVERSE - ${currentProfile.toUpperCase()}`,
                heading: HeadingLevel.HEADING_1,
              }),
              new Paragraph(editorEl.value),
            ],
          }],
        });

        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `eterniverse_${currentProfile}_${Date.now()}.docx`;
        a.click();
        URL.revokeObjectURL(url);
        showStatus('üì§ Eksport zako≈Ñczony!');
        speakText('Zapisano do Word');
      } catch (e) {
        showStatus('‚ùå B≈ÇƒÖd eksportu: ' + e.message);
      }
    }

    // ENTER KEY SUPPORT
    consoleEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        processConsoleText(consoleEl.value);
      }
    });

    // WELCOME
    speakText('Bella gotowa. Wpisz REDAGUJ lub u≈ºyj mikrofonu.');
    addHistory('üöÄ System zainicjowany');
  })();
  </script>
</body>
</html>