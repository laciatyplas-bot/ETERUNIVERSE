<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eterniverse – Czysta Wersja</title>
  <meta name="description" content="Czysta, minimalistyczna wersja Eterniverse z wszystkimi silnikami">

  <!-- Eksport DOCX -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #222;
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid #444;
    }
    header h1 {
      margin: 0;
      font-size: 2.5rem;
    }
    header p {
      margin: 10px 0 0;
      font-size: 1.2rem;
      opacity: 0.8;
    }
    .toolbar {
      background: #222;
      padding: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      border-bottom: 1px solid #444;
    }
    button, select {
      padding: 10px 15px;
      background: #333;
      color: #eee;
      border: 1px solid #555;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #444;
    }
    .layout {
      display: grid;
      grid-template-columns: 350px 1fr 400px;
      gap: 15px;
      padding: 15px;
      flex: 1;
      overflow: hidden;
    }
    .section {
      background: #1e1e1e;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    .section h2 {
      margin: 0 0 15px 0;
      font-size: 1.4rem;
      color: #0cf;
    }
    #current-path {
      margin-bottom: 10px;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    #element-title {
      width: 100%;
      padding: 10px;
      font-size: 1.8rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid #0cf;
      color: #eee;
      margin-bottom: 15px;
    }
    textarea {
      flex: 1;
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      color: #eee;
      font-size: 1.1rem;
      resize: none;
    }
    .tree-node {
      padding: 10px;
      margin: 5px 0;
      background: #282828;
      border-left: 4px solid #555;
      cursor: pointer;
      border-radius: 4px;
    }
    .tree-node:hover {
      background: #333;
      border-left-color: #0cf;
    }
    .tree-node.selected {
      border-left-color: #0cf;
      background: #003366;
    }
    .nested { margin-left: 20px; }
    .status {
      background: #222;
      padding: 15px;
      text-align: center;
      border-top: 1px solid #444;
      font-size: 1rem;
    }
    @media (max-width: 1200px) {
      .layout { grid-template-columns: 1fr 1fr; }
      .section:nth-child(3) { grid-column: span 2; }
    }
    @media (max-width: 800px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ETERNIVERSE</h1>
    <p>Czysta wersja – wszystkie silniki w jednym pliku</p>
  </header>

  <div class="toolbar">
    <select id="profile-select">
      <option value="wattpad">Wattpad</option>
      <option value="amazon">Amazon</option>
    </select>
    <button id="add-universe">+ Nowe Uniwersum</button>
    <button id="add-child">+ Dziecko</button>
    <button id="generate-story">AI Generuj</button>
    <button id="bella-analyze">Bella Analiza</button>
    <button id="export-docx">Eksport DOCX</button>
    <button id="save-project-file">Zapisz Projekt</button>
    <button id="load-project-file">Wczytaj Projekt</button>
    <input type="file" id="file-input" accept=".eterniverse,.json" style="display:none;">
    <button id="start-dictate">Dyktuj</button>
    <button id="stop-dictate" disabled>Stop</button>
  </div>

  <div class="layout">
    <div class="section">
      <h2>Hierarchia</h2>
      <div id="current-path"></div>
      <div style="flex:1;overflow-y:auto;" id="structure-tree"></div>

      <h2 style="margin-top:20px;">Brama Eteryczne</h2>
      <div style="flex:1;overflow-y:auto;" id="mapa-grid"></div>
    </div>

    <div class="section">
      <input type="text" id="element-title" placeholder="Tytuł elementu...">
      <textarea id="element-content" placeholder="Treść elementu..."></textarea>
    </div>

    <div class="section">
      <h2>Sugestie AI</h2>
      <div style="flex:1;overflow-y:auto;" id="suggestions">
        <p style="text-align:center;opacity:0.7;padding:40px 0;">
          Wybierz element i użyj AI lub Bella Analiza
        </p>
      </div>
    </div>
  </div>

  <div class="status" id="status">Gotowy</div>

  <!-- WSZYSTKIE SILNIKI W JEDNYM SKRYPCIE -->
  <script>
    'use strict';

    // DataMaster – pamięć
    class DataMaster {
      constructor() {
        this.KEYS = { STRUCTURE: 'structure', MAPA: 'mapa', PROFILE: 'profile' };
        this.structure = this.load(this.KEYS.STRUCTURE, []);
        this.mapa = this.load(this.KEYS.MAPA, this.defaultMapa());
        this.profile = this.load(this.KEYS.PROFILE, 'wattpad');
      }
      defaultMapa() {
        const names = ["INTERSEEKER", "ETERSEEKER", "OBFITOSEEKER", "THE KNOT", "RELIGIOSEEKER", "LUXSEEKER", "UMBRASEEKER", "AETHERSEEKER", "CHRONOSEEKER", "VOIDSEEKER"];
        return names.map((n, i) => ({ id: i+1, name: `BRAMA ${i+1} — ${n}`, books: [`Księga ${i+1}.1`, `Księga ${i+1}.2`] }));
      }
      load(k, f) { try { return JSON.parse(localStorage.getItem(k)) || f; } catch { return f; } }
      save(k, d) { try { localStorage.setItem(k, JSON.stringify(d)); } catch {} }
      getStructure() { return this.structure; }
      setStructure(s) { this.structure = s; this.save(this.KEYS.STRUCTURE, s); }
      getMapa() { return this.mapa; }
      getProfile() { return this.profile; }
      setProfile(p) { this.profile = p; this.save(this.KEYS.PROFILE, p); }
    }

    // Renderer
    class Renderer {
      constructor(app) {
        this.app = app;
        this.e = {
          tree: document.getElementById('structure-tree'),
          mapa: document.getElementById('mapa-grid'),
          sugg: document.getElementById('suggestions'),
          title: document.getElementById('element-title'),
          content: document.getElementById('element-content'),
          path: document.getElementById('current-path'),
          status: document.getElementById('status')
        };
      }
      renderAll() {
        this.renderStructure();
        this.renderMapa();
        this.renderEdit();
        this.renderSuggestions([]);
      }
      renderStructure() {
        const c = this.e.tree;
        const s = this.app.data.getStructure();
        if (s.length === 0) { c.innerHTML = '<p style="text-align:center;padding:30px;opacity:0.6;">+ Nowe Uniwersum</p>'; return; }
        c.innerHTML = s.map(r => this.buildNode(r)).join('');
      }
      buildNode(n) {
        const selected = this.app.currentElement?.id === n.id;
        let h = `<div class="tree-node \( {selected ? 'selected' : ''}" onclick="master.selectElement(' \){n.id}')">
          <strong>\( {n.title || '(bez tytułu)'}</strong> <small> \){n.type || ''}</small>
        </div>`;
        if (n.children?.length) h += `<div class="nested">${n.children.map(ch => this.buildNode(ch)).join('')}</div>`;
        return h;
      }
      renderMapa() {
        const c = this.e.mapa;
        const m = this.app.data.getMapa();
        c.innerHTML = m.map(b => `
          <div class="tree-node" onclick="master.insertBrama(${b.id})">
            <strong>${b.name}</strong>
            <small>${b.books.length} ksiąg</small>
          </div>
        `).join('');
      }
      renderEdit() {
        const el = this.app.currentElement;
        this.e.title.value = el?.title || '';
        this.e.content.value = el?.content || '';
        this.e.path.textContent = el ? this.app.getPathToElement(el).map(n => n.title || n.type).join(' → ') : '';
      }
      renderSuggestions(items) {
        const p = this.e.sugg;
        p.innerHTML = items.length ? items.map(i => `<div>${i.text}</div>`).join('') : '<p style="text-align:center;opacity:0.6;padding:40px;">Użyj AI lub Bella Analiza</p>';
      }
      setStatus(m, t=5000) {
        this.e.status.textContent = m;
        if (t > 0) setTimeout(() => this.e.status.textContent = 'Gotowy', t);
      }
    }

    // Główny Master
    class EterniverseMasterPRO {
      constructor() {
        this.data = new DataMaster();
        this.renderer = new Renderer(this);
        this.currentElement = null;
        this.currentProfile = this.data.getProfile();
        this.recognition = null;
        this.init();
      }
      init() {
        this.bindEvents();
        this.renderer.renderAll();
        this.initSpeech();
        this.renderer.setStatus('Gotowy');
      }
      bindEvents() {
        document.getElementById('profile-select').value = this.currentProfile;
        document.getElementById('profile-select').onchange = e => {
          this.currentProfile = e.target.value;
          this.data.setProfile(this.currentProfile);
        };
        document.getElementById('add-universe').onclick = () => this.addRootUniverse();
        document.getElementById('add-child').onclick = () => this.addChildElement();
        document.getElementById('generate-story').onclick = () => this.generateAIContent();
        document.getElementById('bella-analyze').onclick = () => this.bellaDeepAnalysis();
        document.getElementById('export-docx').onclick = () => this.exportToDocx();
        document.getElementById('save-project-file').onclick = () => this.saveToFile();
        document.getElementById('load-project-file').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => this.loadFromFile(e.target.files[0]);
        document.getElementById('element-title').oninput = () => this.autoSaveCurrent();
        document.getElementById('element-content').oninput = () => this.autoSaveCurrent();
      }
      generateUniqueId() {
        return 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      }
      addRootUniverse() {
        const u = { id: this.generateUniqueId(), type: 'Uniwersum', title: 'Nowe Uniwersum', content: '', children: [] };
        const s = this.data.getStructure();
        s.push(u);
        this.data.setStructure(s);
        this.currentElement = u;
        this.renderer.renderAll();
      }
      addChildElement() {
        if (!this.currentElement) return;
        const types = ['Uniwersum','Świat','Tom','Rozdział','Podrozdział','Fragment'];
        const idx = types.indexOf(this.currentElement.type || 'Uniwersum');
        const type = types[idx + 1] || 'Fragment';
        const c = { id: this.generateUniqueId(), type, title: `Nowy ${type}`, content: '', children: [] };
        this.currentElement.children.push(c);
        this.data.setStructure(this.data.getStructure());
        this.currentElement = c;
        this.renderer.renderAll();
      }
      selectElement(id) {
        this.currentElement = this.findElementById(id, this.data.getStructure());
        this.renderer.renderAll();
      }
      findElementById(id, nodes) {
        for (const n of nodes) {
          if (n.id === id) return n;
          if (n.children?.length) {
            const f = this.findElementById(id, n.children);
            if (f) return f;
          }
        }
        return null;
      }
      getPathToElement(el) {
        const p = [];
        const t = (ns) => {
          for (const n of ns) {
            if (n.id === el.id) { p.unshift(n); return true; }
            if (n.children?.length && t(n.children)) { p.unshift(n); return true; }
          }
          return false;
        };
        t(this.data.getStructure());
        return p;
      }
      autoSaveCurrent() {
        if (!this.currentElement) return;
        this.currentElement.title = document.getElementById('element-title').value.trim() || '(bez tytułu)';
        this.currentElement.content = document.getElementById('element-content').value;
        this.data.setStructure(this.data.getStructure());
      }
      insertBrama(id) {
        const b = this.data.getMapa().find(x => x.id === id);
        if (!b || !this.currentElement) return;
        const list = b.books.map(t => `• ${t}`).join('\n');
        document.getElementById('element-content').value += `\n\n=== \( {b.name} ===\n \){list}\n\n`;
        this.autoSaveCurrent();
      }
      generateAIContent() {
        const txt = this.currentProfile === 'amazon' 
          ? '⭐⭐⭐⭐⭐ Bestseller! Rewolucyjna historia.'
          : 'W jego oczach była cała wieczność...';
        document.getElementById('element-content').value += `\n\n--- AI ---\n${txt}`;
        this.autoSaveCurrent();
        this.renderer.renderSuggestions([{type:'generated',text:txt}]);
      }
      bellaDeepAnalysis() {
        const s = ['Dodaj dialogi', 'Wzmocnij emocje', 'Rozwijaj sceny'];
        this.renderer.renderSuggestions(s.map(t=>({type:'suggestion',text:t})));
      }
      async exportToDocx() {
        if (!this.currentElement) return this.renderer.setStatus('Brak elementu');
        const { Document, Packer, Paragraph } = docx;
        const doc = new Document({
          sections: [{ children: [new Paragraph(this.currentElement.title || 'Bez tytułu'), new Paragraph(this.currentElement.content || '')] }]
        });
        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'eterniverse.docx';
        a.click();
        URL.revokeObjectURL(url);
      }
      saveToFile() {
        const d = { structure: this.data.getStructure(), mapa: this.data.getMapa(), profile: this.currentProfile };
        const blob = new Blob([JSON.stringify(d, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'eterniverse_project.eterniverse';
        a.click();
        URL.revokeObjectURL(url);
      }
      loadFromFile(file) {
        const r = new FileReader();
        r.onload = e => {
          try {
            const imp = JSON.parse(e.target.result);
            this.data.setStructure(imp.structure || []);
            this.currentProfile = imp.profile || 'wattpad';
            this.renderer.renderAll();
          } catch { this.renderer.setStatus('Błąd pliku'); }
        };
        r.readAsText(file);
      }
      initSpeechRecognition() {
        if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) return;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SR();
        this.recognition.lang = 'pl-PL';
        this.recognition.continuous = true;
        this.recognition.interimResults = true;
        this.recognition.onresult = ev => {
          let f = '';
          for (let i = ev.resultIndex; i < ev.results.length; i++) {
            if (ev.results[i].isFinal) f += ev.results[i][0].transcript;
          }
          if (f) {
            document.getElementById('element-content').value += f + ' ';
            this.autoSaveCurrent();
          }
        };
        this.recognition.onstart = () => {
          document.getElementById('start-dictate').disabled = true;
          document.getElementById('stop-dictate').disabled = false;
        };
        this.recognition.onend = () => {
          document.getElementById('start-dictate').disabled = false;
          document.getElementById('stop-dictate').disabled = true;
        };
      }
      startDictation() { if (this.recognition) this.recognition.start(); }
      stopDictation() { if (this.recognition) this.recognition.stop(); }
      status(m, t=5000) { this.renderer.setStatus(m, t); }
    }

    const master = new EterniverseMasterPRO();
    window.master = master;
  </script>
</body>
</html>