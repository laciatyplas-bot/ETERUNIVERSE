<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eterniverse Master Premium PRO v14.0 – Local File System Integration</title>
  <meta name="description" content="Pełna integracja z lokalnym systemem plików – zapisywanie i wczytywanie projektów jako pliki .eterniverse">

  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>

  <!-- Twój istniejący CSS (kwantowy lub forma style) -->
  <style>
    /* Wklej tutaj swój preferowany CSS z poprzednich wersji */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@300;400;500;600&display=swap');

    :root {
      --quantum-bg: #0b0014;
      --aether-glow: #00e0ff;
      --quantum-gold: #c0a0ff;
      --text-light: #f0f0ff;
      --border-glow: rgba(0, 224, 255, 0.3);
    }

    body { font-family: 'Inter', sans-serif; background: var(--quantum-bg); color: var(--text-light); height: 100vh; overflow: hidden; }
    /* ... reszta Twojego CSS */
  </style>
</head>
<body>
  <!-- Twój istniejący HTML layout -->
  <header><h1>ETERNIVERSE</h1><p>v14.0 – Local File System Integration</p></header>

  <div class="toolbar">
    <button id="save-project-file" class="gold">Zapisz Projekt jako Plik</button>
    <button id="load-project-file" class="primary">Wczytaj Projekt z Pliku</button>
    <input type="file" id="file-input" accept=".eterniverse,.json" style="display:none;">
    <!-- Reszta przycisków -->
  </div>

  <!-- Reszta layoutu -->
  <div class="layout">
    <!-- ... Twoje sekcje ... -->
  </div>

  <div class="status" id="status">Integracja z lokalnym systemem plików aktywna</div>

  <script>
    'use strict';

    class EterniverseMasterPRO {
      constructor() {
        this.VERSION = 'v14.0-fs';
        this.FILE_EXTENSION = '.eterniverse';
        this.data = window.dataMaster || null;

        this.currentElement = null;
        this.currentProfile = this.data?.getProfile() || 'wattpad';

        this.init();
      }

      init() {
        if (!this.data) {
          console.error('DataMaster nie załadowany');
          return;
        }

        this.bindFileSystemEvents();
        this.status(`Eterniverse ${this.VERSION} — lokalny system plików zintegrowany`);
      }

      bindFileSystemEvents() {
        // Zapisz projekt jako plik
        document.getElementById('save-project-file').addEventListener('click', () => this.saveProjectToFile());

        // Wczytaj projekt z pliku
        document.getElementById('load-project-file').addEventListener('click', () => {
          document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) this.loadProjectFromFile(file);
        });
      }

      // === ZAPIS DO LOKALNEGO PLIKU ===
      saveProjectToFile() {
        const projectData = {
          eterniverse_version: this.VERSION,
          save_date: new Date().toISOString(),
          project_name: this.currentElement?.title || 'Mój Projekt Eterniverse',
          structure: this.data.getStructure(),
          mapa: this.data.getMapa(),
          profile: this.data.getProfile(),
          settings: this.data.getSettings(),
          backups: this.data.getBackups()
        };

        const dataStr = JSON.stringify(projectData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `\( {projectData.project_name.replace(/[^a-z0-9]/gi, '_')}_ \){new Date().toISOString().slice(0,10)}${this.FILE_EXTENSION}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        this.status('Projekt zapisany jako plik lokalny');
      }

      // === WCZYTANIE Z LOKALNEGO PLIKU ===
      loadProjectFromFile(file) {
        if (!file.name.endsWith(this.FILE_EXTENSION) && !file.name.endsWith('.json')) {
          this.status('Nieprawidłowy format pliku – użyj .eterniverse lub .json', 8000);
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);

            if (confirm(`Wczytać projekt "${imported.project_name || 'bez nazwy'}" z ${new Date(imported.save_date).toLocaleDateString('pl-PL')}?\nTo nadpisze bieżące dane.`)) {
              // Przywróć dane
              this.data.setStructure(imported.structure || []);
              this.data.setMapa(imported.mapa || this.data.defaultMapa());
              this.data.setProfile(imported.profile || 'wattpad');
              this.data.updateSettings(imported.settings || this.data.defaultSettings());
              if (imported.backups) this.data.backups = imported.backups;

              this.currentProfile = this.data.getProfile();

              // Odśwież UI
              this.renderEverything();
              this.status('Projekt wczytany z pliku lokalnego – wszechświat przywrócony');
            }
          } catch (err) {
            console.error(err);
            this.status('Błąd odczytu pliku – nieprawidłowy format JSON', 8000);
          }
        };

        reader.onerror = () => {
          this.status('Błąd odczytu pliku', 8000);
        };

        reader.readAsText(file);
      }

      // === RESZTA FUNKCJI (z poprzednich wersji) ===
      renderEverything() {
        if (window.renderer) window.renderer.renderAll();
      }

      status(message, duration = 6000) {
        if (window.renderer) {
          window.renderer.setStatus(message, duration);
        } else {
          const el = document.getElementById('status');
          if (el) el.textContent = message;
        }
      }

      // ... reszta metod: addUniverse, addChild, selectElement, autoSave, generateAI, bellaAnalysis, exportDocx, etc.
    }

    // Uruchomienie
    const master = new EterniverseMasterPRO();
    window.master = master;

    console.log('Eterniverse v14.0 – pełna integracja z lokalnym systemem plików aktywna');
  </script>
</body>
</html>