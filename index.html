<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eterniverse – Lazy Loading Drzewa</title>

  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Arial,sans-serif; background:#111; color:#eee; min-height:100vh; display:flex; flex-direction:column; }
    header { background:#222; padding:15px; text-align:center; border-bottom:1px solid #444; }
    header h1 { font-size:2rem; }
    .toolbar { background:#222; padding:10px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; border-bottom:1px solid #444; }
    button, select { padding:10px 14px; background:#333; color:#eee; border:1px solid #555; border-radius:6px; cursor:pointer; font-size:0.95rem; }
    button:hover { background:#444; }
    .layout { flex:1; padding:10px; display:grid; grid-template-columns:1fr; gap:12px; overflow:hidden; }
    .section { background:#1e1e1e; border:1px solid #444; border-radius:8px; padding:14px; display:flex; flex-direction:column; overflow:hidden; }
    .section h2 { margin-bottom:10px; font-size:1.3rem; color:#0cf; }
    #current-path { margin-bottom:8px; font-size:0.9rem; color:#c0a0ff; }
    #element-title { width:100%; padding:10px; font-size:1.6rem; background:transparent; border:none; border-bottom:2px solid #0cf; color:#eee; margin-bottom:12px; text-align:center; }
    textarea { flex:1; background:#222; border:1px solid #444; border-radius:6px; padding:12px; color:#eee; font-size:1rem; resize:none; }
    .tree-node {
      padding:10px;
      margin:6px 0;
      background:#282828;
      border-left:4px solid #555;
      border-radius:4px;
      cursor:pointer;
      display:flex;
      align-items:center;
    }
    .tree-node:hover { background:#333; border-left-color:#0cf; }
    .tree-node.selected { border-left-color:#0cf; background:#003366; }
    .tree-expander {
      margin-right:8px;
      font-weight:bold;
      width:16px;
      text-align:center;
    }
    .nested { margin-left:24px; }
    .status { background:#222; padding:12px; text-align:center; border-top:1px solid #444; font-size:0.95rem; }

    @media (min-width:768px) { .layout { grid-template-columns:1fr 1fr; } .section:nth-child(3){grid-column:span 2;} }
    @media (min-width:1024px) { .layout { grid-template-columns:350px 1fr 400px; } .section:nth-child(3){grid-column:unset;} }
  </style>
</head>
<body>
  <header><h1>ETERNIVERSE</h1></header>

  <div class="toolbar">
    <select id="profile-select"><option value="wattpad">Wattpad</option><option value="amazon">Amazon</option></select>
    <button id="add-universe">+ Nowe Uniwersum</button>
    <button id="add-child">+ Dziecko</button>
    <button id="generate-story">AI Generuj</button>
    <button id="bella-analyze">Bella Analiza</button>
    <button id="export-docx">DOCX</button>
    <button id="save-project-file">Zapisz</button>
    <button id="load-project-file">Wczytaj</button>
    <input type="file" id="file-input" accept=".eterniverse,.json" style="display:none;">
    <button id="start-dictate">Dyktuj</button>
    <button id="stop-dictate" disabled>Stop</button>
  </div>

  <div class="layout">
    <div class="section"><h2>Hierarchia (Lazy Loading)</h2><div id="current-path"></div><div id="structure-tree" style="flex:1;overflow-y:auto;"></div></div>
    <div class="section"><h2>Edytor</h2><input type="text" id="element-title" placeholder="Tytuł..."><textarea id="element-content" placeholder="Treść..."></textarea></div>
    <div class="section"><h2>Brama & Sugestie</h2><div id="mapa-grid" style="flex:1;overflow-y:auto;"></div><div id="suggestions" style="margin-top:15px;"></div></div>
  </div>

  <div class="status" id="status">Gotowy</div>

  <script>
    'use strict';

    class DataMaster{
      constructor(){
        this.k={s:'struct',m:'mapa',p:'prof'};
        this.structure=this.l(this.k.s,[]);
        this.mapa=this.l(this.k.m,this.dm());
        this.profile=this.l(this.k.p,'wattpad');
      }
      dm(){
        const n=["INTERSEEKER","ETERSEEKER","OBFITOSEEKER","THE KNOT","RELIGIOSEEKER","LUXSEEKER","UMBRASEEKER","AETHERSEEKER","CHRONOSEEKER","VOIDSEEKER"];
        return n.map((name,i)=>({id:i+1,name:`BRAMA ${i+1} — ${name}`,books:[`Księga ${i+1}.1`,`Księga ${i+1}.2`]}));
      }
      l(k,f){try{return JSON.parse(localStorage.getItem(k))||f;}catch{return f;}}
      sv(k,d){try{localStorage.setItem(k,JSON.stringify(d));}catch{}}
      getStructure(){return this.structure;}
      setStructure(s){this.structure=s;this.sv(this.k.s,s);}
      getMapa(){return this.mapa;}
      getProfile(){return this.profile;}
      setProfile(p){this.profile=p;this.sv(this.k.p,p);}
    }

    class Renderer{
      constructor(app){
        this.app=app;
        this.e={
          tree:document.getElementById('structure-tree'),
          mapa:document.getElementById('mapa-grid'),
          sugg:document.getElementById('suggestions'),
          title:document.getElementById('element-title'),
          content:document.getElementById('element-content'),
          path:document.getElementById('current-path'),
          status:document.getElementById('status')
        };
      }
      renderAll(){this.renderStructure();this.renderMapa();this.renderEdit();this.renderSuggestions([]);}
      renderStructure(){
        const c=this.e.tree;
        const s=this.app.data.getStructure();
        if(s.length===0){c.innerHTML='<p style="text-align:center;padding:30px;opacity:0.6;">+ Nowe Uniwersum</p>';return;}
        let html='';
        for(let i=0;i<s.length;i++) html+=this.buildLazyNode(s[i]);
        c.innerHTML=html;
      }
      buildLazyNode(n){
        const sel=this.app.currentElement?.id===n.id;
        const hasChildren=n.children?.length>0;
        const expander=hasChildren ? '<span class="tree-expander" onclick="event.stopPropagation();master.toggleChildren(this.parentNode.dataset.id)">+</span>' : '<span class="tree-expander"></span>';
        let h=`<div class="tree-node \( {sel?'selected':''}" data-id=" \){n.id}" onclick="master.selectElement('${n.id}')">
          \( {expander}<strong> \){n.title||'(bez tytułu)'}</strong> <small>${n.type||''}</small>
        </div>`;
        if(hasChildren){
          h+=`<div class="nested" style="display:none;"></div>`;
        }
        return h;
      }
      renderChildren(parentNode,n){
        let html='';
        for(let i=0;i<n.children.length;i++) html+=this.buildLazyNode(n.children[i]);
        parentNode.nextElementSibling.innerHTML=html;
      }
      renderMapa(){
        const c=this.e.mapa;
        const m=this.app.data.getMapa();
        let html='';
        for(let i=0;i<m.length;i++) html+=`<div class="tree-node" onclick="master.insertBrama(${m[i].id})">
          <strong>\( {m[i].name}</strong> <small> \){m[i].books.length} ksiąg</small>
        </div>`;
        c.innerHTML=html;
      }
      renderEdit(){
        const el=this.app.currentElement;
        this.e.title.value=el?.title||'';
        this.e.content.value=el?.content||'';
        this.e.path.textContent=el?this.app.getPathToElement(el).map(n=>n.title||n.type).join(' → '):'';
      }
      renderSuggestions(items){
        const p=this.e.sugg;
        if(items.length===0){p.innerHTML='<p style="text-align:center;padding:30px;opacity:0.6;">Użyj Bella Analiza lub AI</p>';return;}
        let html='';
        for(let i=0;i<items.length;i++) html+=`<div>${items[i].text}</div>`;
        p.innerHTML=html;
      }
      setStatus(m,t=5000){
        this.e.status.textContent=m;
        if(t>0) setTimeout(()=>{this.e.status.textContent='Gotowy';},t);
      }
    }

    class EterniverseMasterPRO{
      constructor(){
        this.data=new DataMaster();
        this.renderer=new Renderer(this);
        this.currentElement=null;
        this.currentProfile=this.data.getProfile();
        this.recognition=null;
        this.expandedNodes=new Set();
        this.init();
      }
      init(){
        this.bindEvents();
        this.renderer.renderAll();
        this.initSpeechRecognition();
        this.renderer.setStatus('Gotowy');
      }
      bindEvents(){
        document.getElementById('profile-select').value=this.currentProfile;
        document.getElementById('profile-select').onchange=e=>{this.currentProfile=e.target.value;this.data.setProfile(this.currentProfile);};
        document.getElementById('add-universe').onclick=()=>this.addRootUniverse();
        document.getElementById('add-child').onclick=()=>this.addChildElement();
        document.getElementById('generate-story').onclick=()=>this.generateAIContent();
        document.getElementById('bella-analyze').onclick=()=>this.bellaDeepAnalysis();
        document.getElementById('export-docx').onclick=()=>this.exportToDocx();
        document.getElementById('save-project-file').onclick=()=>this.saveToFile();
        document.getElementById('load-project-file').onclick=()=>document.getElementById('file-input').click();
        document.getElementById('file-input').onchange=e=>this.loadFromFile(e.target.files[0]);
        document.getElementById('element-title').oninput=()=>this.autoSaveCurrent();
        document.getElementById('element-content').oninput=()=>this.autoSaveCurrent();
        document.getElementById('start-dictate').onclick=()=>this.startDictation();
        document.getElementById('stop-dictate').onclick=()=>this.stopDictation();
      }
      generateUniqueId(){return 'id_'+Date.now().toString(36)+Math.random().toString(36).substr(2,5);}
      addRootUniverse(){
        const u={id:this.generateUniqueId(),type:'Uniwersum',title:'Nowe Uniwersum',content:'',children:[]};
        const s=this.data.getStructure();s.push(u);this.data.setStructure(s);
        this.currentElement=u;this.renderer.renderAll();
      }
      addChildElement(){
        if(!this.currentElement)return;
        const types=['Uniwersum','Świat','Tom','Rozdział','Podrozdział','Fragment'];
        const idx=types.indexOf(this.currentElement.type||'Uniwersum');
        const type=types[idx+1]||'Fragment';
        const c={id:this.generateUniqueId(),type,title:`Nowy ${type}`,content:'',children:[]};
        this.currentElement.children.push(c);
        this.data.setStructure(this.data.getStructure());
        this.currentElement=c;
        const parentNode=document.querySelector(`.tree-node[data-id="${this.currentElement.id}"]`);
        if(parentNode && parentNode.nextElementSibling) parentNode.nextElementSibling.style.display='block';
        this.renderer.renderAll();
      }
      selectElement(id){
        this.currentElement=this.findElementById(id,this.data.getStructure());
        this.renderer.renderAll();
      }
      findElementById(id,nodes){
        for(const n of nodes){
          if(n.id===id)return n;
          if(n.children?.length){
            const f=this.findElementById(id,n.children);
            if(f)return f;
          }
        }
        return null;
      }
      getPathToElement(el){
        const p=[];const t=(ns)=>{for(const n of ns){if(n.id===el.id){p.unshift(n);return true;}if(n.children?.length&&t(n.children)){p.unshift(n);return true;}}return false;};
        t(this.data.getStructure());return p;
      }
      autoSaveCurrent(){
        if(!this.currentElement) return;
        this.currentElement.title=document.getElementById('element-title').value.trim()||'(bez tytułu)';
        this.currentElement.content=document.getElementById('element-content').value;
        this.data.setStructure(this.data.getStructure());
      }
      insertBrama(id){
        const b=this.data.getMapa().find(x=>x.id===id);
        if(!b||!this.currentElement)return;
        const l=b.books.map(t=>`• ${t}`).join('\n');
        document.getElementById('element-content').value+=`\n\n=== \( {b.name} ===\n \){l}\n\n`;
        this.autoSaveCurrent();
      }
      generateAIContent(){
        const txt=this.currentProfile==='amazon'?'⭐⭐⭐⭐⭐ Bestseller!':'W jego oczach była wieczność...';
        document.getElementById('element-content').value+=`\n\n--- AI ---\n${txt}`;
        this.autoSaveCurrent();
        this.renderer.renderSuggestions([{type:'generated',text:txt}]);
      }
      bellaDeepAnalysis(){
        const s=['Dodaj dialogi','Wzmocnij emocje','Rozwijaj sceny'];
        this.renderer.renderSuggestions(s.map(t=>({type:'suggestion',text:t})));
      }
      async exportToDocx(){
        if(!this.currentElement)return this.renderer.setStatus('Brak elementu');
        const {Document,Packer,Paragraph}=docx;
        const doc=new Document({sections:[{children:[new Paragraph(this.currentElement.title||'Bez tytułu'),new Paragraph(this.currentElement.content||'')] }]});
        const blob=await Packer.toBlob(doc);
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');a.href=url;a.download='eterniverse.docx';a.click();URL.revokeObjectURL(url);
      }
      saveToFile(){
        const d={structure:this.data.getStructure(),mapa:this.data.getMapa(),profile:this.currentProfile};
        const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');a.href=url;a.download='eterniverse.eterniverse';a.click();URL.revokeObjectURL(url);
      }
      loadFromFile(file){
        const r=new FileReader();
        r.onload=e=>{
          try{
            const imp=JSON.parse(e.target.result);
            this.data.setStructure(imp.structure||[]);
            this.currentProfile=imp.profile||'wattpad';
            this.renderer.renderAll();
          }catch{this.renderer.setStatus('Błąd pliku');}
        };
        r.readAsText(file);
      }
      toggleChildren(id){
        const node=document.querySelector(`.tree-node[data-id="${id}"]`);
        if(!node) return;
        const childrenContainer=node.nextElementSibling;
        if(!childrenContainer) return;
        const isExpanded=childrenContainer.style.display==='block';
        childrenContainer.style.display=isExpanded?'none':'block';
        node.querySelector('.tree-expander').textContent=isExpanded?'+':'−';
        if(!isExpanded && childrenContainer.innerHTML===''){
          const element=this.findElementById(id,this.data.getStructure());
          if(element && element.children?.length){
            this.renderer.renderChildren(node,element);
          }
        }
      }
      initSpeechRecognition(){
        if(!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) return;
        const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
        this.recognition=new SR();
        this.recognition.lang='pl-PL';
        this.recognition.continuous=true;
        this.recognition.interimResults=true;
        this.recognition.onresult=ev=>{
          let f='';
          for(let i=ev.resultIndex;i<ev.results.length;i++){
            if(ev.results[i].isFinal) f+=ev.results[i][0].transcript;
          }
          if(f){
            document.getElementById('element-content').value+=f+' ';
            this.autoSaveCurrent();
          }
        };
        this.recognition.onstart=()=>{document.getElementById('start-dictate').disabled=true;document.getElementById('stop-dictate').disabled=false;};
        this.recognition.onend=()=>{document.getElementById('start-dictate').disabled=false;document.getElementById('stop-dictate').disabled=true;};
      }
      startDictation(){if(this.recognition)this.recognition.start();}
      stopDictation(){if(this.recognition)this.recognition.stop();}
      status(m,t=5000){this.renderer.setStatus(m,t);}
    }

    const master = new EterniverseMasterPRO();
    window.master = master;
  </script>
</body>
</html>