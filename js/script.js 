// script.js - Eterniverse Master Premium v6.0
// GÅ‚Ã³wny skrypt aplikacji: KsiÄ…Å¼ki + Struktura + Mapa Bram + Bella AI + Dyktowanie + Eksport DOCX

'use strict';

class EterniverseMaster {
  constructor() {
    // Dane wbudowane â€“ Mapa Bram Eteruniverse
    this.DEFAULT_MAPA = [
      { id: 1, name: "BRAMA 1 â€” INTERSEEKER", books: [{ title: "INTERSEEKER: Geneza" }, { title: "INTERSEEKER: Efekt Cienia" }] },
      { id: 2, name: "BRAMA 2 â€” ETERSEEKER", books: [{ title: "EterSeeker: Kronika Woli" }, { title: "Interfejs ÅšwiadomoÅ›ci" }] },
      { id: 3, name: "BRAMA 3 â€” OBFITOSEEKER", books: [{ title: "ObfitoSeeker â€“ Kod ObfitoÅ›ci" }] },
      { id: 4, name: "BRAMA 4 â€” THE KNOT", books: [{ title: "Kronika SplÄ…tania" }, { title: "Eterniony Tom I" }] },
      { id: 5, name: "BRAMA 5 â€” RELIGIOSEEKER", books: [{ title: "ReligioSeeker" }] }
    ];

    // Klucze localStorage
    this.BOOKS_KEY = 'eterniverse_books_v6';
    this.STRUCT_KEY = 'eterniverse_structure_v6';
    this.MAPA_KEY = 'eterniverse_mapa_v6';

    // Åadowanie danych
    this.books = this.load(this.BOOKS_KEY, []);
    this.structure = this.load(this.STRUCT_KEY, []);
    this.mapa = this.load(this.MAPA_KEY, this.DEFAULT_MAPA);

    // Stan aplikacji
    this.currentBook = null;
    this.currentProfile = localStorage.getItem('eterniverse_profile') || 'wattpad';
    this.recognition = null;

    this.init();
  }

  // === PODSTAWOWE OPERACJE NA STORAGE ===
  load(key, fallback) {
    try {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : fallback;
    } catch (e) {
      console.warn(`BÅ‚Ä…d odczytu ${key}:`, e);
      return fallback;
    }
  }

  save(key, data) {
    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
      console.error(`BÅ‚Ä…d zapisu ${key}:`, e);
    }
  }

  // === INICJALIZACJA ===
  init() {
    this.updateProfileSelect();
    this.bindEvents();
    this.renderAll();
    this.initSpeech();
    this.status('Eterniverse Master Premium v6.0 â€” gotowy do kreacji');
  }

  updateProfileSelect() {
    const select = document.getElementById('profile-select');
    if (select) select.value = this.currentProfile;
  }

  bindEvents() {
    // Profil
    const profileSelect = document.getElementById('profile-select');
    if (profileSelect) {
      profileSelect.onchange = (e) => {
        this.currentProfile = e.target.value;
        localStorage.setItem('eterniverse_profile', this.currentProfile);
      };
    }

    // Przyciski
    document.getElementById('add-book-btn')?.addEventListener('click', () => this.addBook());
    document.getElementById('add-universe')?.addEventListener('click', () => this.addUniverse());
    document.getElementById('bella-analyze')?.addEventListener('click', () => this.bellaAnalyze());
    document.getElementById('export-docx')?.addEventListener('click', () => this.exportDocx());
    document.getElementById('start-dictate')?.addEventListener('click', () => this.startDictation());
    document.getElementById('stop-dictate')?.addEventListener('click', () => this.stopDictation());

    // Autozapis
    document.getElementById('book-title')?.addEventListener('input', () => this.autoSave());
    document.getElementById('book-content')?.addEventListener('input', () => this.autoSave());
  }

  // === RENDEROWANIE ===
  renderAll() {
    this.renderBooks();
    this.renderStructure();
    this.renderMapa();
    this.renderSuggestions([]);
  }

  renderBooks() {
    const container = document.getElementById('books-list');
    if (!container) return;

    if (this.books.length === 0) {
      container.innerHTML = '<p style="opacity:0.6;text-align:center;padding:2rem;">Kliknij â€+ Nowa KsiÄ™gaâ€, by zaczÄ…Ä‡</p>';
      return;
    }

    container.innerHTML = this.books.map(book => `
      <div class="item \( {this.currentBook?.id === book.id ? 'active' : ''}" onclick="master.openBook( \){book.id})">
        <strong>ğŸ“– ${this.escape(book.title || 'Bez tytuÅ‚u')}</strong>
        <div style="font-size:0.9rem;opacity:0.8;margin-top:0.4rem;">
          ${this.wordCount(book.content || '')} sÅ‚Ã³w
        </div>
      </div>
    `).join('');
  }

  renderStructure() {
    const container = document.getElementById('structure-tree');
    if (!container) return;

    if (this.structure.length === 0) {
      container.innerHTML = '<p style="opacity:0.6;text-align:center;padding:1rem;">Dodaj pierwsze uniwersum</p>';
      return;
    }

    container.innerHTML = this.structure.map(item => this.buildTreeNode(item)).join('');
  }

  buildTreeNode(item) {
    const icon = { 'Uniwersum': 'ğŸŒŒ', 'Åšwiat': 'ğŸŒ', 'Tom': 'ğŸ“š' }[item.type] || 'ğŸ“„';
    const children = item.children?.length
      ? `<div class="nested">${item.children.map(c => this.buildTreeNode(c)).join('')}</div>`
      : '';

    return `
      <div class="item">
        ${icon} ${this.escape(item.title)}
        ${children}
      </div>
    `;
  }

  renderMapa() {
    const container = document.getElementById('mapa-grid');
    if (!container) return;

    container.innerHTML = this.mapa.map(brama => `
      <div class="item" onclick="master.insertBrama(${brama.id})">
        <strong>ğŸ”® ${this.escape(brama.name)}</strong>
        <div style="font-size:0.9rem;opacity:0.8;margin-top:0.4rem;">
          ${brama.books?.length || 0} tytuÅ‚Ã³w
        </div>
      </div>
    `).join('');
  }

  renderSuggestions(suggestions) {
    const container = document.getElementById('suggestions');
    if (!container) return;

    if (suggestions.length === 0) {
      container.innerHTML = '<p style="text-align:center;opacity:0.7;padding:2rem;">Kliknij â€Bella AIâ€, by otrzymaÄ‡ sugestie</p>';
      return;
    }

    container.innerHTML = suggestions.map(s => `<div class="suggestion">${s}</div>`).join('');
  }

  renderCurrentBook() {
    if (!this.currentBook) {
      document.getElementById('book-title')?.setAttribute('value', '');
      document.getElementById('book-content')?.setAttribute('value', '');
      return;
    }

    document.getElementById('book-title').value = this.currentBook.title || '';
    document.getElementById('book-content').value = this.currentBook.content || '';
  }

  // === OPERACJE NA KSIÄ˜GACH ===
  addBook() {
    const newBook = {
      id: Date.now(),
      title: 'Nowa KsiÄ™ga Eteryczna',
      content: '',
      created: new Date().toISOString()
    };

    this.books.unshift(newBook);
    this.save(this.BOOKS_KEY, this.books);
    this.openBook(newBook.id);
    this.status('Nowa ksiÄ™ga utworzona');
  }

  openBook(id) {
    this.currentBook = this.books.find(b => b.id === id);
    if (this.currentBook) {
      this.renderCurrentBook();
      this.renderBooks();
    }
  }

  autoSave() {
    if (!this.currentBook) return;

    this.currentBook.title = document.getElementById('book-title')?.value || '';
    this.currentBook.content = document.getElementById('book-content')?.value || '';
    this.save(this.BOOKS_KEY, this.books);
  }

  // === STRUKTURA ===
  addUniverse() {
    const newUniv = {
      id: Date.now(),
      type: 'Uniwersum',
      title: 'Nowe Uniwersum',
      children: []
    };

    this.structure.push(newUniv);
    this.save(this.STRUCT_KEY, this.structure);
    this.renderStructure();
    this.status('Nowe uniwersum dodane');
  }

  // === MAPA BRAM ===
  insertBrama(id) {
    const brama = this.mapa.find(b => b.id === id);
    if (!this.currentBook || !brama) return;

    const list = brama.books?.map(b => `ğŸ“– ${b.title}`).join('\n') || '';
    const textarea = document.getElementById('book-content');
    textarea.value += `\n\nâœ¦ === \( {brama.name} === âœ¦\n \){list}\n\n`;
    this.autoSave();
    this.status(`Wstawiono: ${brama.name}`);
  }

  // === BELLA AI ===
  bellaAnalyze() {
    if (!this.currentBook || !this.currentBook.content?.trim()) {
      this.status('Brak tekstu do analizy');
      return;
    }

    const suggestions = this.generateSuggestions(this.currentBook.content);
    this.renderSuggestions(suggestions);
    this.status(`${suggestions.length} sugestii od Bella AI`);
  }

  generateSuggestions(text) {
    const suggestions = [];
    const lower = text.toLowerCase();
    const wordCount = this.wordCount(text);

    if (this.currentProfile === 'amazon') {
      if (!/darmowa|wysyÅ‚ka|gwarancja|satysfakcja/i.test(lower))
        suggestions.push('ğŸ“¦ Dodaj frazy: â€darmowa wysyÅ‚kaâ€, â€gwarancja satysfakcjiâ€');
      if (!/najlepszy|rewolucyjny|premium|ekskluzywny/i.test(lower))
        suggestions.push('ğŸ† UÅ¼yj sÅ‚Ã³w premium: najlepszy, rewolucyjny, ekskluzywny');
    } else {
      if (!text.match(/["â€â€]/))
        suggestions.push('ğŸ’¬ Dodaj dialogi â€“ zwiÄ™kszajÄ… zaangaÅ¼owanie na Wattpad');
      if ((lower.match(/(miÅ‚oÅ›Ä‡|strach|radoÅ›Ä‡|smutek|przeraÅ¼|nadzieja|gniew|zakocha)/g) || []).length < 5)
        suggestions.push('â¤ï¸ WpleÄ‡ wiÄ™cej emocji â€“ czytelnik musi czuÄ‡ historiÄ™');
    }

    if (wordCount < 300) suggestions.push('ğŸ“ˆ RozwiÅ„ tekst â€“ dÅ‚uÅ¼sze rozdziaÅ‚y majÄ… wiÄ™kszy zasiÄ™g');
    if (text.split('\n\n').length < 5) suggestions.push('âœ¨ WiÄ™cej akapitÃ³w â€“ lepsza czytelnoÅ›Ä‡');

    return suggestions;
  }

  // === EKSPORT DOCX ===
  async exportDocx() {
    if (!this.currentBook) {
      this.status('Brak otwartej ksiÄ™gi');
      return;
    }

    const { Document, Packer, Paragraph, HeadingLevel } = docx;

    const doc = new Document({
      sections: [{
        children: [
          new Paragraph({ text: this.currentBook.title || 'Bez tytuÅ‚u', heading: HeadingLevel.TITLE, alignment: "center" }),
          new Paragraph({ text: `Eterniverse â€¢ ${this.currentProfile.toUpperCase()} â€¢ ${new Date().toLocaleDateString('pl-PL')}`, alignment: "center" }),
          new Paragraph({ text: this.currentBook.content || '' })
        ]
      }]
    });

    try {
      const blob = await Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(this.currentBook.title || 'ksiega').replace(/[^a-z0-9]/gi, '_')}_Eterniverse.docx`;
      a.click();
      URL.revokeObjectURL(url);
      this.status('Eksport DOCX zakoÅ„czony');
    } catch (err) {
      this.status('BÅ‚Ä…d eksportu');
      console.error(err);
    }
  }

  // === DYKTowanie ===
  initSpeech() {
    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
      console.log('Dyktowanie nieobsÅ‚ugiwane w tej przeglÄ…darce');
      return;
    }

    this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    this.recognition.lang = 'pl-PL';
    this.recognition.continuous = true;
    this.recognition.interimResults = true;

    this.recognition.onresult = (event) => {
      const transcript = Array.from(event.results)
        .map(result => result[0].transcript)
        .join('');
      const textarea = document.getElementById('book-content');
      if (textarea) {
        textarea.value += transcript;
        this.autoSave();
      }
    };

    this.recognition.onstart = () => {
      document.getElementById('start-dictate')?.setAttribute('disabled', 'true');
      document.getElementById('stop-dictate')?.removeAttribute('disabled');
      this.status('ğŸ™ï¸ Dyktowanie aktywne');
    };

    this.recognition.onend = () => {
      document.getElementById('start-dictate')?.removeAttribute('disabled');
      document.getElementById('stop-dictate')?.setAttribute('disabled', 'true');
    };
  }

  startDictation() { this.recognition?.start(); }
  stopDictation() { this.recognition?.stop(); }

  // === STATUS ===
  status(message, duration = 5000) {
    const statusEl = document.getElementById('status');
    if (statusEl) {
      statusEl.textContent = message;
      if (duration > 0) {
        setTimeout(() => {
          if (statusEl.textContent === message) {
            statusEl.textContent = 'Gotowy';
          }
        }, duration);
      }
    }
  }

  // === POMOCNICZE ===
  wordCount(text = '') {
    return (text.match(/\b\w+\b/g) || []).length;
  }

  escape(text = '') {
    return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
}

// Uruchomienie aplikacji po zaÅ‚adowaniu DOM
document.addEventListener('DOMContentLoaded', () => {
  window.master = new EterniverseMaster();
});