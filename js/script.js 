// script.js - Eterniverse Master Premium PRO v8.0
// PeÅ‚na, dziaÅ‚ajÄ…ca wersja JavaScript

'use strict';

class EterniverseMasterPRO {
  constructor() {
    this.STRUCT_KEY = 'eterniverse_structure_pro_v8';
    this.MAPA_KEY = 'eterniverse_mapa_pro';

    this.structure = this.load(this.STRUCT_KEY, []);
    this.mapa = this.load(this.MAPA_KEY, this.defaultMapa());

    this.currentElement = null;
    this.currentProfile = localStorage.getItem('eterniverse_profile') || 'wattpad';
    this.recognition = null;

    this.init();
  }

  defaultMapa() {
    return [
      { id: 1, name: "BRAMA 1 â€” INTERSEEKER", books: ["INTERSEEKER: Geneza", "INTERSEEKER: Efekt Cienia"] },
      { id: 2, name: "BRAMA 2 â€” ETERSEEKER", books: ["EterSeeker: Kronika Woli", "Interfejs ÅšwiadomoÅ›ci"] },
      { id: 3, name: "BRAMA 3 â€” OBFITOSEEKER", books: ["ObfitoSeeker â€“ Kod ObfitoÅ›ci"] },
      { id: 4, name: "BRAMA 4 â€” THE KNOT", books: ["Kronika SplÄ…tania", "Eterniony Tom I"] },
      { id: 5, name: "BRAMA 5 â€” RELIGIOSEEKER", books: ["ReligioSeeker"] }
    ];
  }

  load(key, fallback) {
    try {
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : fallback;
    } catch (e) {
      console.error('BÅ‚Ä…d Å‚adowania:', e);
      return fallback;
    }
  }

  save(key, data) {
    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
      console.error('BÅ‚Ä…d zapisu:', e);
    }
  }

  init() {
    this.updateProfile();
    this.bindEvents();
    this.renderAll();
    this.initSpeech();
    this.status('Eterniverse Master Premium PRO â€” gotowy');
  }

  updateProfile() {
    const select = document.getElementById('profile-select');
    if (select) select.value = this.currentProfile;
  }

  bindEvents() {
    document.getElementById('profile-select').onchange = e => {
      this.currentProfile = e.target.value;
      localStorage.setItem('eterniverse_profile', this.currentProfile);
    };

    document.getElementById('add-universe').onclick = () => this.addRootUniverse();
    document.getElementById('add-child').onclick = () => this.addChild();
    document.getElementById('bella-analyze').onclick = () => this.bellaAnalyze();
    document.getElementById('export-docx').onclick = () => this.exportDocx();
    document.getElementById('start-dictate').onclick = () => this.startDictation();
    document.getElementById('stop-dictate').onclick = () => this.stopDictation();

    document.getElementById('element-title').oninput = () => this.autoSave();
    document.getElementById('element-content').oninput = () => this.autoSave();
  }

  renderAll() {
    this.renderStructure();
    this.renderMapa();
    this.renderSuggestions([]);
    this.updateCurrentPath();
  }

  // === STRUKTURA ===
  renderStructure() {
    const container = document.getElementById('structure-tree');
    if (!container) return;

    if (this.structure.length === 0) {
      container.innerHTML = '<p style="opacity:0.6;text-align:center;padding:2rem;">Kliknij â€+ Nowe Uniwersumâ€, by zaczÄ…Ä‡</p>';
      return;
    }

    container.innerHTML = this.structure.map(root => this.buildNode(root)).join('');
  }

  buildNode(node) {
    const icon = {
      'Uniwersum': 'ğŸŒŒ',
      'Åšwiat': 'ğŸŒ',
      'Tom': 'ğŸ“š',
      'RozdziaÅ‚': 'ğŸ“–',
      'PodrozdziaÅ‚': 'ğŸ“„',
      'Fragment': 'ğŸ“œ'
    }[node.type] || 'ğŸ“„';

    const selected = this.currentElement && this.currentElement.id === node.id;

    let html = `
      <div class="tree-node \( {selected ? 'selected' : ''}" onclick="master.selectElement(' \){node.id}')">
        <span class="icon">${icon}</span>
        <strong>${this.escape(node.title || '(Bez tytuÅ‚u)')}</strong>
        <small style="margin-left:8px;opacity:0.7;">${node.type || ''}</small>
    `;

    if (node.children && node.children.length > 0) {
      html += `<div class="nested">${node.children.map(child => this.buildNode(child)).join('')}</div>`;
    }

    html += `</div>`;
    return html;
  }

  selectElement(id) {
    this.currentElement = this.findById(id);
    if (this.currentElement) {
      document.getElementById('element-title').value = this.currentElement.title || '';
      document.getElementById('element-content').value = this.currentElement.content || '';
      this.renderStructure();
      this.updateCurrentPath();
    }
  }

  findById(id, nodes = this.structure) {
    for (const node of nodes) {
      if (node.id === id) return node;
      if (node.children && node.children.length) {
        const found = this.findById(id, node.children);
        if (found) return found;
      }
    }
    return null;
  }

  getPathTo(element) {
    const path = [];
    const traverse = (nodes) => {
      for (const node of nodes) {
        if (node.id === element.id) {
          path.unshift(node);
          return true;
        }
        if (node.children && node.children.length && traverse(node.children)) {
          path.unshift(node);
          return true;
        }
      }
      return false;
    };
    traverse(this.structure);
    return path;
  }

  updateCurrentPath() {
    const pathEl = document.getElementById('current-path');
    if (!pathEl) return;

    if (!this.currentElement) {
      pathEl.textContent = '';
      return;
    }

    const path = this.getPathTo(this.currentElement);
    pathEl.textContent = path.map(n => n.title || n.type).join(' â†’ ');
  }

  addRootUniverse() {
    const newUniv = {
      id: this.generateId(),
      type: 'Uniwersum',
      title: 'Nowe Uniwersum',
      content: '',
      children: []
    };

    this.structure.push(newUniv);
    this.save(this.STRUCT_KEY, this.structure);
    this.renderStructure();
    this.selectElement(newUniv.id);
    this.status('Utworzono nowe uniwersum');
  }

  addChild() {
    if (!this.currentElement) {
      alert('Wybierz element nadrzÄ™dny');
      return;
    }

    const types = ['Uniwersum', 'Åšwiat', 'Tom', 'RozdziaÅ‚', 'PodrozdziaÅ‚', 'Fragment'];
    const currentIdx = types.indexOf(this.currentElement.type || 'Uniwersum');
    const childType = types[currentIdx + 1] || 'Fragment';

    const newChild = {
      id: this.generateId(),
      type: childType,
      title: `Nowy ${childType}`,
      content: '',
      children: []
    };

    this.currentElement.children = this.currentElement.children || [];
    this.currentElement.children.push(newChild);
    this.save(this.STRUCT_KEY, this.structure);
    this.renderStructure();
    this.selectElement(newChild.id);
    this.status(`Dodano: ${childType}`);
  }

  autoSave() {
    if (!this.currentElement) return;

    this.currentElement.title = document.getElementById('element-title').value.trim();
    this.currentElement.content = document.getElementById('element-content').value;

    this.save(this.STRUCT_KEY, this.structure);
  }

  // === MAPA BRAM ===
  renderMapa() {
    const container = document.getElementById('mapa-grid');
    if (!container) return;

    container.innerHTML = this.mapa.map(brama => `
      <div class="tree-node" onclick="master.insertBrama(${brama.id})">
        <span class="icon">ğŸ”®</span>
        <strong>${this.escape(brama.name)}</strong>
        <small style="margin-left:8px;opacity:0.7;">${brama.books?.length || 0} tytuÅ‚Ã³w</small>
      </div>
    `).join('');
  }

  insertBrama(id) {
    const brama = this.mapa.find(b => b.id === id);
    if (!this.currentElement || !brama) return;

    const list = brama.books?.map(t => `â€¢ ${t}`).join('\n') || '';
    const textarea = document.getElementById('element-content');
    textarea.value += `\n\nâœ¦ === \( {brama.name} === âœ¦\n \){list}\n\n`;
    this.autoSave();
    this.status(`Wstawiono: ${brama.name}`);
  }

  // === BELLA AI PRO ===
  bellaAnalyze() {
    if (!this.currentElement || !this.currentElement.content?.trim()) {
      this.status('Brak treÅ›ci do analizy');
      return;
    }

    const suggestions = this.generateProSuggestions(this.currentElement);
    this.renderSuggestions(suggestions);
    this.status(`${suggestions.length} sugestii PRO`);
  }

  generateProSuggestions(element) {
    const text = element.content || '';
    const lower = text.toLowerCase();
    const type = element.type || 'Fragment';
    const suggestions = [];

    if (['Uniwersum', 'Åšwiat'].includes(type)) {
      if (text.length < 200) suggestions.push('ğŸŒ Opisz fundamenty Å›wiata: prawa, magia, historia');
      if (!lower.includes('geografia') && !lower.includes('mapa')) suggestions.push('ğŸ—ºï¸ Dodaj opis geografii i kluczowych lokacji');
    }

    if (['Tom', 'RozdziaÅ‚', 'PodrozdziaÅ‚'].includes(type)) {
      if (!text.match(/["â€â€]/)) suggestions.push('ğŸ’¬ WprowadÅº dialogi â€“ oÅ¼ywiajÄ… postaci');
      if (!lower.includes('konflikt') && !lower.includes('cel')) suggestions.push('âš”ï¸ Zdefiniuj gÅ‚Ã³wny konflikt lub cel bohatera');
    }

    if (this.currentProfile === 'amazon') {
      if (!/limitowan|ekskluzywn|specjaln/i.test(lower)) suggestions.push('ğŸ”¥ PodkreÅ›l unikalnoÅ›Ä‡: â€edycja limitowanaâ€, â€tylko tutajâ€');
    } else {
      const emotions = (lower.match(/(miÅ‚oÅ›Ä‡|strach|radoÅ›Ä‡|smutek|gniew|nadzieja|przeraÅ¼|zakocha)/g) || []).length;
      if (emotions < 5) suggestions.push('â¤ï¸ Wzmocnij emocje â€“ Wattpad Å¼yje uczuciami');
    }

    if (this.wordCount(text) < 500) suggestions.push('ğŸ“œ Rozwijaj sceny â€“ szczegÃ³Å‚y budujÄ… immersjÄ™');

    return suggestions;
  }

  renderSuggestions(suggestions) {
    const panel = document.getElementById('suggestions');
    if (!panel) return;

    if (suggestions.length === 0) {
      panel.innerHTML = '<p style="text-align:center;opacity:0.7;padding:3rem;">Perfekcyjny tekst â€“ brak sugestii</p>';
      return;
    }

    panel.innerHTML = suggestions.map(s => `<div class="suggestion">${s}</div>`).join('');
  }

  // === EKSPORT DOCX ===
  async exportDocx() {
    if (!this.currentElement) {
      this.status('Nie wybrano elementu');
      return;
    }

    const { Document, Packer, Paragraph, HeadingLevel } = docx;
    const path = this.getPathTo(this.currentElement);

    const doc = new Document({
      sections: [{
        children: [
          new Paragraph({ text: this.currentElement.title || 'Bez tytuÅ‚u', heading: HeadingLevel.TITLE, alignment: "center" }),
          new Paragraph({ text: path.map(n => n.title || n.type).join(' â†’ '), alignment: "center" }),
          new Paragraph({ text: `Typ: ${this.currentElement.type} â€¢ ${new Date().toLocaleDateString('pl-PL')}`, alignment: "center" }),
          new Paragraph({ text: this.currentElement.content || '', spacing: { after: 300 } })
        ]
      }]
    });

    try {
      const blob = await Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(this.currentElement.title || 'element').replace(/[^a-z0-9]/gi, '_')}_Eterniverse_PRO.docx`;
      a.click();
      URL.revokeObjectURL(url);
      this.status('Eksport PRO zakoÅ„czony');
    } catch (e) {
      this.status('BÅ‚Ä…d eksportu');
      console.error(e);
    }
  }

  // === DYKTowanie ===
  initSpeech() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      console.log('Dyktowanie nieobsÅ‚ugiwane');
      return;
    }

    this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    this.recognition.lang = 'pl-PL';
    this.recognition.continuous = true;
    this.recognition.interimResults = true;

    this.recognition.onresult = (e) => {
      const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
      const textarea = document.getElementById('element-content');
      if (textarea) {
        textarea.value += transcript;
        this.autoSave();
      }
    };

    this.recognition.onstart = () => {
      document.getElementById('start-dictate').disabled = true;
      document.getElementById('stop-dictate').disabled = false;
      this.status('Dyktowanie aktywne');
    };

    this.recognition.onend = () => {
      document.getElementById('start-dictate').disabled = false;
      document.getElementById('stop-dictate').disabled = true;
    };
  }

  startDictation() { this.recognition?.start(); }
  stopDictation() { this.recognition?.stop(); }

  // === POMOCNICZE ===
  generateId() {
    return 'node_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
  }

  status(msg, time = 6000) {
    const el = document.getElementById('status');
    if (!el) return;
    el.textContent = msg;
    if (time > 0) {
      setTimeout(() => {
        if (el.textContent === msg) el.textContent = 'Gotowy';
      }, time);
    }
  }

  wordCount(text = '') {
    return (text.match(/\b\w+\b/g) || []).length;
  }

  escape(text = '') {
    return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
}

// Uruchomienie
const master = new EterniverseMasterPRO();
window.master = master;