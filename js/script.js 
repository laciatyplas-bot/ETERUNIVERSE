// script.js â€” Eterniverse Master Premium PRO v8.1 (STABLE)
// PEÅNA, POPRAWIONA WERSJA

'use strict';

class EterniverseMasterPRO {
  constructor() {
    this.STRUCT_KEY = 'eterniverse_structure_pro_v8';
    this.MAPA_KEY = 'eterniverse_mapa_pro';

    this.structure = this.load(this.STRUCT_KEY, []);
    this.mapa = this.load(this.MAPA_KEY, this.defaultMapa());

    this.currentElement = null;
    this.currentProfile = localStorage.getItem('eterniverse_profile') || 'wattpad';

    this.recognition = null;
    this.isDictating = false;

    this.init();
  }

  /* =========================
     DEFAULT DATA
  ========================= */
  defaultMapa() {
    return [
      { id: 1, name: 'BRAMA 1 â€” INTERSEEKER', books: ['INTERSEEKER: Geneza', 'INTERSEEKER: Efekt Cienia'] },
      { id: 2, name: 'BRAMA 2 â€” ETERSEEKER', books: ['EterSeeker: Kronika Woli', 'Interfejs ÅšwiadomoÅ›ci'] },
      { id: 3, name: 'BRAMA 3 â€” OBFITOSEEKER', books: ['ObfitoSeeker â€“ Kod ObfitoÅ›ci'] },
      { id: 4, name: 'BRAMA 4 â€” THE KNOT', books: ['Kronika SplÄ…tania', 'Eterniony Tom I'] },
      { id: 5, name: 'BRAMA 5 â€” RELIGIOSEEKER', books: ['ReligioSeeker'] }
    ];
  }

  /* =========================
     STORAGE
  ========================= */
  load(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch (e) {
      console.error('BÅ‚Ä…d Å‚adowania:', e);
      return fallback;
    }
  }

  save(key, data) {
    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
      console.error('BÅ‚Ä…d zapisu:', e);
    }
  }

  /* =========================
     INIT
  ========================= */
  init() {
    this.bindEvents();
    this.renderAll();
    this.initSpeech();
    this.status('Eterniverse Master Premium PRO â€” gotowy');
  }

  bindEvents() {
    const qs = (id) => document.getElementById(id);

    qs('profile-select')?.addEventListener('change', e => {
      this.currentProfile = e.target.value;
      localStorage.setItem('eterniverse_profile', this.currentProfile);
    });

    qs('add-universe')?.addEventListener('click', () => this.addRootUniverse());
    qs('add-child')?.addEventListener('click', () => this.addChild());
    qs('bella-analyze')?.addEventListener('click', () => this.bellaAnalyze());
    qs('export-docx')?.addEventListener('click', () => this.exportDocx());
    qs('start-dictate')?.addEventListener('click', () => this.startDictation());
    qs('stop-dictate')?.addEventListener('click', () => this.stopDictation());

    qs('element-title')?.addEventListener('input', () => this.autoSave());
    qs('element-content')?.addEventListener('input', () => this.autoSave());

    // Delegacja klikÃ³w â€” DRZEWO + BRAMY
    document.addEventListener('click', (e) => {
      const tree = e.target.closest('.tree-node[data-id]');
      if (tree) {
        this.selectElement(tree.dataset.id);
        return;
      }

      const brama = e.target.closest('.brama-card[data-id]');
      if (brama) {
        this.insertBrama(brama.dataset.id);
      }
    });
  }

  /* =========================
     RENDER
  ========================= */
  renderAll() {
    this.renderStructure();
    this.renderMapa();
    this.renderSuggestions([]);
    this.updateCurrentPath();
  }

  renderStructure() {
    const c = document.getElementById('structure-tree');
    if (!c) return;

    if (!this.structure.length) {
      c.innerHTML = `<p style="opacity:.6;text-align:center;padding:2rem;">Kliknij â€+ Nowe Uniwersumâ€, by zaczÄ…Ä‡</p>`;
      return;
    }

    c.innerHTML = this.structure.map(n => this.buildNode(n)).join('');
  }

  buildNode(node) {
    const icons = {
      Uniwersum: 'ğŸŒŒ',
      Åšwiat: 'ğŸŒ',
      Tom: 'ğŸ“š',
      RozdziaÅ‚: 'ğŸ“–',
      PodrozdziaÅ‚: 'ğŸ“„',
      Fragment: 'ğŸ“œ'
    };

    const selected = this.currentElement && this.currentElement.id === node.id;

    return `
      <div class="tree-node ${selected ? 'selected' : ''}"
           data-id="${node.id}">
        <span class="icon">${icons[node.type] || 'ğŸ“„'}</span>
        <strong>${this.escape(node.title || '(Bez tytuÅ‚u)')}</strong>
        <small style="margin-left:6px;opacity:.7;">${node.type || ''}</small>
        ${
          node.children?.length
            ? `<div class="nested">
                ${node.children.map(c => this.buildNode(c)).join('')}
               </div>`
            : ''
        }
      </div>
    `;
  }

  renderMapa() {
    const c = document.getElementById('mapa-grid');
    if (!c) return;

    c.innerHTML = this.mapa.map((b, i) => `
      <div class="brama-card" data-id="${b.id}" style="--order:${i}">
        <div class="brama-name">${this.escape(b.name)}</div>
        <div class="brama-books">${b.books?.length || 0} tytuÅ‚Ã³w</div>
        <div class="brama-hint">Kliknij, aby wstawiÄ‡</div>
      </div>
    `).join('');
  }

  /* =========================
     SELECTION / PATH
  ========================= */
  selectElement(id) {
    this.currentElement = this.findById(id);
    if (!this.currentElement) return;

    const t = document.getElementById('element-title');
    const c = document.getElementById('element-content');
    if (t) t.value = this.currentElement.title || '';
    if (c) c.value = this.currentElement.content || '';

    this.renderStructure();
    this.updateCurrentPath();
  }

  findById(id, nodes = this.structure) {
    for (const n of nodes) {
      if (String(n.id) === String(id)) return n;
      if (n.children) {
        const f = this.findById(id, n.children);
        if (f) return f;
      }
    }
    return null;
  }

  getPathTo(el) {
    const path = [];
    const walk = (nodes) => {
      for (const n of nodes) {
        if (n === el) {
          path.unshift(n);
          return true;
        }
        if (n.children && walk(n.children)) {
          path.unshift(n);
          return true;
        }
      }
      return false;
    };
    walk(this.structure);
    return path;
  }

  updateCurrentPath() {
    const p = document.getElementById('current-path');
    if (!p) return;

    if (!this.currentElement) {
      p.textContent = '';
      return;
    }

    p.textContent = this.getPathTo(this.currentElement)
      .map(n => n.title || n.type)
      .join(' â†’ ');
  }

  /* =========================
     CRUD
  ========================= */
  addRootUniverse() {
    const u = {
      id: this.generateId(),
      type: 'Uniwersum',
      title: 'Nowe Uniwersum',
      content: '',
      children: []
    };
    this.structure.push(u);
    this.save(this.STRUCT_KEY, this.structure);
    this.renderStructure();
    this.selectElement(u.id);
    this.status('Utworzono nowe uniwersum');
  }

  addChild() {
    if (!this.currentElement) {
      alert('Wybierz element nadrzÄ™dny');
      return;
    }

    const order = ['Uniwersum', 'Åšwiat', 'Tom', 'RozdziaÅ‚', 'PodrozdziaÅ‚', 'Fragment'];
    const idx = order.indexOf(this.currentElement.type);
    const type = order[idx + 1] || 'Fragment';

    const c = {
      id: this.generateId(),
      type,
      title: `Nowy ${type}`,
      content: '',
      children: []
    };

    this.currentElement.children ||= [];
    this.currentElement.children.push(c);

    this.save(this.STRUCT_KEY, this.structure);
    this.renderStructure();
    this.selectElement(c.id);
    this.status(`Dodano: ${type}`);
  }

  autoSave() {
    if (!this.currentElement) return;

    const t = document.getElementById('element-title');
    const c = document.getElementById('element-content');

    this.currentElement.title = t?.value || '';
    this.currentElement.content = c?.value || '';

    this.save(this.STRUCT_KEY, this.structure);
  }

  insertBrama(id) {
    const b = this.mapa.find(x => String(x.id) === String(id));
    if (!b || !this.currentElement) return;

    const list = b.books?.map(t => `â€¢ ${t}`).join('\n') || '';
    const c = document.getElementById('element-content');
    if (!c) return;

    c.value += `\n\nâœ¦ === ${b.name} === âœ¦\n${list}\n\n`;
    this.autoSave();
    this.status(`Wstawiono: ${b.name}`);
  }

  /* =========================
     BELLA AI
  ========================= */
  bellaAnalyze() {
    if (!this.currentElement?.content?.trim()) {
      this.status('Brak treÅ›ci do analizy');
      return;
    }
    const s = this.generateProSuggestions(this.currentElement);
    this.renderSuggestions(s);
    this.status(`${s.length} sugestii PRO`);
  }

  generateProSuggestions(el) {
    const t = el.content.toLowerCase();
    const out = [];

    if (this.wordCount(t) < 500) out.push('ğŸ“œ RozwiÅ„ sceny â€” szczegÃ³Å‚y budujÄ… immersjÄ™');
    if (!/(dialog|powiedziaÅ‚|odparÅ‚|â€)/.test(t)) out.push('ğŸ’¬ Dodaj dialogi');
    if (!/(konflikt|cel|stawka)/.test(t)) out.push('âš”ï¸ WyraÅºny konflikt zwiÄ™ksza napiÄ™cie');

    if (this.currentProfile === 'wattpad' && (t.match(/miÅ‚oÅ›Ä‡|strach|gniew|nadzieja/g) || []).length < 5) {
      out.push('â¤ï¸ Wattpad lubi emocje â€” wzmocnij je');
    }

    return out;
  }

  renderSuggestions(list) {
    const p = document.getElementById('suggestions');
    if (!p) return;

    p.innerHTML = list.length
      ? list.map(s => `<div class="suggestion">${s}</div>`).join('')
      : `<p style="opacity:.7;text-align:center;padding:2rem;">Brak sugestii</p>`;
  }

  /* =========================
     SPEECH
  ========================= */
  initSpeech() {
    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) return;

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    this.recognition = new SR();
    this.recognition.lang = 'pl-PL';
    this.recognition.continuous = true;
    this.recognition.interimResults = false;

    this.recognition.onresult = (e) => {
      const text = Array.from(e.results).map(r => r[0].transcript).join(' ');
      const c = document.getElementById('element-content');
      if (c) {
        c.value += text + ' ';
        this.autoSave();
      }
    };

    this.recognition.onstart = () => {
      this.isDictating = true;
      this.toggleDictation(true);
      this.status('ğŸ¤ Dyktowanie aktywne', 0);
    };

    this.recognition.onend = () => {
      this.isDictating = false;
      this.toggleDictation(false);
      this.status('Dyktowanie zatrzymane', 4000);
    };
  }

  startDictation() {
    if (!this.recognition || this.isDictating) return;
    try { this.recognition.start(); } catch {}
  }

  stopDictation() {
    if (!this.recognition || !this.isDictating) return;
    try { this.recognition.stop(); } catch {}
  }

  toggleDictation(active) {
    const s = document.getElementById('start-dictate');
    const t = document.getElementById('stop-dictate');
    if (s) s.disabled = active;
    if (t) t.disabled = !active;
  }

  /* =========================
     UTILS
  ========================= */
  generateId() {
    return 'node_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  }

  status(msg, time = 6000) {
    const e = document.getElementById('status');
    if (!e) return;
    e.textContent = msg;
    if (time > 0) setTimeout(() => { if (e.textContent === msg) e.textContent = 'Gotowy'; }, time);
  }

  wordCount(t = '') {
    return (t.match(/\b\w+\b/g) || []).length;
  }

  escape(t = '') {
    return String(t).replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }
}

/* =========================
   START
========================= */
const master = new EterniverseMasterPRO();
window.master = master;