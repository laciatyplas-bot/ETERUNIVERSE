// script.js â€” Eterniverse Master Premium PRO v8.2 (STABLE)
// PEÅNA, KOMPLETNA WERSJA â€” WKLEJ 1:1

'use strict';

class EterniverseMasterPRO {
  constructor() {
    this.currentElement = null;
    this.currentProfile = dataMaster?.getProfile() || 'wattpad';
    this.isDictating = false;

    this.init();
  }

  /* =========================
     INIT
  ========================= */
  init() {
    this.bindEvents();
    this.renderAll();
    this.initSpeechRecognition();
    this.status('Eterniverse Master Premium PRO v8.2 â€” system gotowy', 8000);
  }

  bindEvents() {
    const qs = (id) => document.getElementById(id);

    // Profil
    const profileSelect = qs('profile-select');
    if (profileSelect) {
      profileSelect.value = this.currentProfile;
      profileSelect.addEventListener('change', (e) => {
        this.currentProfile = e.target.value;
        dataMaster?.setProfile(this.currentProfile);
        this.status(`Profil zmieniony: ${this.currentProfile.toUpperCase()}`);
      });
    }

    // Dodawanie elementÃ³w
    qs('add-universe')?.addEventListener('click', () => this.addRootUniverse());
    qs('add-child')?.addEventListener('click', () => this.addChild());

    // Bella AI i eksport
    qs('bella-analyze')?.addEventListener('click', () => this.bellaAnalyze());
    qs('export-docx')?.addEventListener('click', () => this.exportToDocx());

    // Dyktowanie
    qs('start-dictate')?.addEventListener('click', () => this.startDictation());
    qs('stop-dictate')?.addEventListener('click', () => this.stopDictation());

    // Autozapis przy edycji
    qs('element-title')?.addEventListener('input', () => this.autoSaveCurrent());
    qs('element-content')?.addEventListener('input', () => this.autoSaveCurrent());

    // Delegacja klikniÄ™Ä‡ w drzewie i mapie bram
    document.addEventListener('click', (e) => {
      const node = e.target.closest('.tree-node[data-id]');
      if (node) {
        this.selectElement(node.dataset.id);
        return;
      }

      const bramaCard = e.target.closest('.brama-card[data-id]');
      if (bramaCard) {
        this.insertBramaReference(bramaCard.dataset.id);
      }
    });
  }

  /* =========================
     RENDEROWANIE
  ========================= */
  renderAll() {
    this.renderStructureTree();
    this.renderMapaGrid();
    this.renderSuggestions([]);
    this.updateCurrentPath();
  }

  renderStructureTree() {
    const container = document.getElementById('structure-tree');
    if (!container) return;

    const structure = dataMaster?.getStructure() || [];

    if (structure.length === 0) {
      container.innerHTML = `<p style="opacity:.6;text-align:center;padding:2rem;">Kliknij â€+ Nowe Uniwersumâ€, aby rozpoczÄ…Ä‡ budowÄ™ struktury.</p>`;
      return;
    }

    container.innerHTML = structure.map(node => this.buildTreeNode(node)).join('');
  }

  buildTreeNode(node) {
    const icons = {
      Uniwersum: 'ğŸŒŒ',
      Åšwiat: 'ğŸŒ',
      Tom: 'ğŸ“š',
      RozdziaÅ‚: 'ğŸ“–',
      PodrozdziaÅ‚: 'ğŸ“„',
      Fragment: 'ğŸ“œ'
    };

    const isSelected = this.currentElement && this.currentElement.id === node.id;

    return `
      <div class="tree-node \( {isSelected ? 'selected' : ''}" data-id=" \){node.id}">
        <span class="node-icon">${icons[node.type] || 'ğŸ“„'}</span>
        <strong class="node-title">${this.escapeHtml(node.title || '(Bez tytuÅ‚u)')}</strong>
        <small class="node-type">${node.type || ''}</small>
        ${node.children && node.children.length > 0
          ? `<div class="nested-children">
              ${node.children.map(child => this.buildTreeNode(child)).join('')}
             </div>`
          : ''
        }
      </div>
    `;
  }

  renderMapaGrid() {
    const container = document.getElementById('mapa-grid');
    if (!container) return;

    const mapa = dataMaster?.getMapa() || [];

    container.innerHTML = mapa.map(brama => `
      <div class="brama-card" data-id="${brama.id}">
        <div class="brama-header">
          <h3 class="brama-name">${this.escapeHtml(brama.name)}</h3>
          <span class="brama-tag">${this.escapeHtml(brama.tag || '')}</span>
        </div>
        <div class="brama-sub">${this.escapeHtml(brama.sub || '')}</div>
        <div class="brama-books-count">${brama.books?.length || 0} tytuÅ‚Ã³w</div>
        <div class="brama-hint">Kliknij, aby wstawiÄ‡ odniesienie</div>
      </div>
    `).join('');
  }

  /* =========================
     SELEKCJA I ÅšCIEÅ»KA
  ========================= */
  selectElement(id) {
    const structure = dataMaster?.getStructure() || [];
    this.currentElement = this.findElementById(id, structure);

    if (!this.currentElement) {
      this.status('Element nie znaleziony');
      return;
    }

    const titleInput = document.getElementById('element-title');
    const contentTextarea = document.getElementById('element-content');

    if (titleInput) titleInput.value = this.currentElement.title || '';
    if (contentTextarea) contentTextarea.value = this.currentElement.content || '';

    this.renderStructureTree();
    this.updateCurrentPath();
    this.status(`Wybrano: ${this.currentElement.title || this.currentElement.type}`);
  }

  findElementById(id, nodes) {
    for (const node of nodes) {
      if (String(node.id) === String(id)) return node;
      if (node.children) {
        const found = this.findElementById(id, node.children);
        if (found) return found;
      }
    }
    return null;
  }

  getPathTo(element, nodes = dataMaster?.getStructure() || []) {
    const path = [];
    const traverse = (list) => {
      for (const node of list) {
        if (node === element) {
          path.unshift(node);
          return true;
        }
        if (node.children && traverse(node.children)) {
          path.unshift(node);
          return true;
        }
      }
      return false;
    };
    traverse(nodes);
    return path;
  }

  updateCurrentPath() {
    const pathContainer = document.getElementById('current-path');
    if (!pathContainer || !this.currentElement) {
      if (pathContainer) pathContainer.textContent = '';
      return;
    }

    const path = this.getPathTo(this.currentElement);
    pathContainer.textContent = path.map(n => n.title || n.type).join(' â†’ ');
  }

  /* =========================
     CRUD â€” STRUKTURA
  ========================= */
  addRootUniverse() {
    const newUniverse = {
      id: this.generateId(),
      type: 'Uniwersum',
      title: 'Nowe Uniwersum',
      content: '',
      children: []
    };

    const structure = dataMaster?.getStructure() || [];
    structure.push(newUniverse);
    dataMaster?.setStructure(structure);

    this.renderStructureTree();
    this.selectElement(newUniverse.id);
    this.status('Utworzono nowe Uniwersum');
  }

  addChild() {
    if (!this.currentElement) {
      this.status('Wybierz element nadrzÄ™dny');
      return;
    }

    const typeOrder = ['Uniwersum', 'Åšwiat', 'Tom', 'RozdziaÅ‚', 'PodrozdziaÅ‚', 'Fragment'];
    const currentIndex = typeOrder.indexOf(this.currentElement.type);
    const newType = typeOrder[currentIndex + 1] || 'Fragment';

    const newChild = {
      id: this.generateId(),
      type: newType,
      title: `Nowy ${newType.toLowerCase()}`,
      content: '',
      children: []
    };

    this.currentElement.children = this.currentElement.children || [];
    this.currentElement.children.push(newChild);

    dataMaster?.setStructure(dataMaster.getStructure());
    this.renderStructureTree();
    this.selectElement(newChild.id);
    this.status(`Dodano: ${newType}`);
  }

  autoSaveCurrent() {
    if (!this.currentElement) return;

    const titleInput = document.getElementById('element-title');
    const contentTextarea = document.getElementById('element-content');

    if (titleInput) this.currentElement.title = titleInput.value.trim();
    if (contentTextarea) this.currentElement.content = contentTextarea.value;

    dataMaster?.setStructure(dataMaster.getStructure());
  }

  insertBramaReference(bramaId) {
    const mapa = dataMaster?.getMapa() || [];
    const brama = mapa.find(b => String(b.id) === String(bramaId));
    if (!brama || !this.currentElement) return;

    const booksList = brama.books?.map(book => `â€¢ ${book.title || book}`).join('\n') || 'Brak tytuÅ‚Ã³w';

    const reference = `\n\nâœ¦ === \( {brama.name} === âœ¦\n \){brama.sub ? brama.sub + '\n' : ''}${booksList}\n\n`;

    const textarea = document.getElementById('element-content');
    if (textarea) {
      textarea.value += reference;
      this.autoSaveCurrent();
      this.status(`Wstawiono odniesienie do: ${brama.name}`);
    }
  }

  /* =========================
     BELLA AI â€” SUGESTIE PRO
  ========================= */
  bellaAnalyze() {
    if (!this.currentElement?.content?.trim()) {
      this.status('Brak treÅ›ci do analizy');
      return;
    }

    const suggestions = this.generateBellaProSuggestions(this.currentElement);
    this.renderSuggestions(suggestions);
    this.status(`${suggestions.length} profesjonalnych sugestii Bella AI`);
  }

  generateBellaProSuggestions(element) {
    const text = element.content || '';
    const lowerText = text.toLowerCase();
    const type = element.type || 'Fragment';

    const suggestions = [];

    const wordCount = this.wordCount(text);
    const paragraphCount = text.split(/\n\s*\n/).filter(p => p.trim()).length;
    const hasDialogues = /["â€][^"â€]{10,}["â€]/.test(text);

    // DÅ‚ugoÅ›Ä‡
    if (wordCount < 500) suggestions.push('ğŸ“œ RozwiÅ„ narracjÄ™ â€“ dÅ‚uÅ¼sze fragmenty budujÄ… gÅ‚Ä™bszÄ… immersjÄ™.');
    if (wordCount > 3500 && ['RozdziaÅ‚', 'PodrozdziaÅ‚'].includes(type)) suggestions.push('âœ‚ï¸ RozwaÅ¼ podziaÅ‚ na mniejsze sekcje â€“ zwiÄ™kszy czytelnoÅ›Ä‡.');

    // Struktura
    if (paragraphCount < 5) suggestions.push('ğŸˆš Dodaj wiÄ™cej akapitÃ³w â€“ kaÅ¼dy nowy wÄ…tek w osobnym bloku.');
    if (!hasDialogues) suggestions.push('ğŸ’¬ WprowadÅº dialogi â€“ oÅ¼ywiajÄ… postaci i dynamizujÄ… scenÄ™.');

    // Profil Wattpad
    if (this.currentProfile === 'wattpad') {
      const emotionCount = (lowerText.match(/miÅ‚oÅ›Ä‡|strach|gniew|nadzieja|poÅ¼Ä…danie|smutek|euforia|rozpacz/g) || []).length;
      if (emotionCount < 6) suggestions.push('â¤ï¸ Wzmocnij emocje â€“ Wattpad premiuje intensywnoÅ›Ä‡ uczuÄ‡.');
      if (!/(nagle|wtedy|zrozumiaÅ‚a|nie wiedziaÅ‚a|coÅ› siÄ™ zmieniÅ‚o)/i.test(text)) {
        suggestions.push('ğŸª ZakoÅ„cz cliffhangerem â€“ zwiÄ™kszy retencjÄ™ czytelnikÃ³w.');
      }
    }

    // Profil Amazon
    if (this.currentProfile === 'amazon') {
      if (!/(bestseller|unikalny|premium|rewolucyjny)/i.test(lowerText)) {
        suggestions.push('ğŸ’ Dodaj sÅ‚owa mocy â€“ budujÄ… postrzeganÄ… wartoÅ›Ä‡ ksiÄ…Å¼ki.');
      }
      if (!/(zamÃ³w|kup|teraz|tylko dziÅ›)/i.test(lowerText)) {
        suggestions.push('ğŸ“ˆ Wstaw wezwanie do dziaÅ‚ania (CTA) â€“ kluczowe dla konwersji.');
      }
    }

    if (suggestions.length === 0) {
      suggestions.push('âœ… Tekst jest spÃ³jny, emocjonalny i dobrze zbalansowany â€” brak uwag.');
    }

    return suggestions;
  }

  renderSuggestions(list) {
    const container = document.getElementById('suggestions');
    if (!container) return;

    container.innerHTML = list.length
      ? list.map(s => `<div class="suggestion-item">${s}</div>`).join('')
      : `<p style="opacity:.6;text-align:center;padding:2rem;">Brak sugestii â€” tekst dopracowany.</p>`;
  }

  /* =========================
     DYKTÃ“WKA GÅOSOWA
  ========================= */
  initSpeechRecognition() {
    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
      this.status('Dyktowanie gÅ‚osowe nieobsÅ‚ugiwane w tej przeglÄ…darce');
      return;
    }

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    this.recognition = new SR();

    this.recognition.lang = 'pl-PL';
    this.recognition.continuous = true;
    this.recognition.interimResults = true;

    this.recognition.onresult = (event) => {
      let final = '';
      let interim = '';

      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          final += transcript;
        } else {
          interim += transcript;
        }
      }

      if (final) {
        const textarea = document.getElementById('element-content');
        if (textarea) {
          textarea.value += final.trim() + ' ';
          textarea.focus();
          this.autoSaveCurrent();
        }
      }

      if (interim) {
        this.status(`ğŸ¤ SÅ‚ucham... "${interim}"`, 0);
      }
    };

    this.recognition.onstart = () => {
      this.isDictating = true;
      this.toggleDictationButtons(true);
      this.status('ğŸ¤ Dyktowanie aktywne â€” mÃ³w teraz', 0);
    };

    this.recognition.onend = () => {
      this.isDictating = false;
      this.toggleDictationButtons(false);
      this.status('Dyktowanie zatrzymane', 4000);
    };

    this.recognition.onerror = (event) => {
      this.isDictating = false;
      this.toggleDictationButtons(false);
      this.status(`BÅ‚Ä…d dyktowania: ${event.error}`, 10000);
    };
  }

  startDictation() {
    if (!this.recognition || this.isDictating) return;
    try {
      this.recognition.start();
    } catch (e) {
      this.status('Nie moÅ¼na uruchomiÄ‡ dyktowania');
    }
  }

  stopDictation() {
    if (!this.recognition || !this.isDictating) return;
    try {
      this.recognition.stop();
    } catch (e) {}
  }

  toggleDictationButtons(active) {
    const startBtn = document.getElementById('start-dictate');
    const stopBtn = document.getElementById('stop-dictate');
    if (startBtn) startBtn.disabled = active;
    if (stopBtn) stopBtn.disabled = !active;
  }

  /* =========================
     EKSPORT (PLACEHOLDER)
  ========================= */
  exportToDocx() {
    this.status('Eksport DOCX â€” funkcja w przygotowaniu');
    // Tu w przyszÅ‚oÅ›ci integracja z docx.js lub server-side
  }

  /* =========================
     UTILSY
  ========================= */
  generateId() {
    return 'el_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
  }

  status(message, timeout = 6000) {
    const statusEl = document.getElementById('status');
    if (!statusEl) return;

    statusEl.textContent = message;
    if (timeout > 0) {
      setTimeout(() => {
        if (statusEl.textContent === message) {
          statusEl.textContent = 'Gotowy';
        }
      }, timeout);
    }
  }

  wordCount(text = '') {
    return text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
  }

  escapeHtml(text = '') {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

/* =========================
   URUCHOMIENIE
========================= */
document.addEventListener('DOMContentLoaded', () => {
  // Oczekujemy na zaÅ‚adowanie DataMaster
  if (window.dataMaster) {
    window.master = new EterniverseMasterPRO();
    console.log('ğŸŒŒ Eterniverse Master Premium PRO v8.2 uruchomiony');
  } else {
    console.error('DataMaster nie zaÅ‚adowany â€” aplikacja nie moÅ¼e dziaÅ‚aÄ‡');
  }
});