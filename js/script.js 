// script.js â€” Eterniverse Master PRO
// KANON / STABLE / ZGODNY Z DataMaster v14.3

'use strict';

class EterniverseMasterPRO {
  constructor() {
    this.currentElement = null;
    this.currentProfile = 'wattpad';
    this.isDictating = false;

    this.init();
  }

  /* =========================
     INIT
  ========================= */
  init() {
    this.bindEvents();
    this.renderAll();
    this.initSpeechRecognition();
    this.status('Eterniverse Master â€” system gotowy', 5000);
  }

  bindEvents() {
    const qs = id => document.getElementById(id);

    // Profil (LOCAL ONLY â€” DataMaster nie trzyma profilu)
    const profileSelect = qs('profile-select');
    if (profileSelect) {
      profileSelect.value = this.currentProfile;
      profileSelect.addEventListener('change', e => {
        this.currentProfile = e.target.value;
        this.status(`Profil: ${this.currentProfile.toUpperCase()}`);
      });
    }

    qs('add-universe')?.addEventListener('click', () => this.addRootUniverse());
    qs('add-child')?.addEventListener('click', () => this.addChild());

    qs('bella-analyze')?.addEventListener('click', () => this.bellaAnalyze());

    qs('start-dictate')?.addEventListener('click', () => this.startDictation());
    qs('stop-dictate')?.addEventListener('click', () => this.stopDictation());
  }

  /* =========================
     RENDER
  ========================= */
  renderAll() {
    this.renderStructureTree();
    this.renderMapa();
    this.renderSuggestions([]);
  }

  renderMapa() {
    const container = document.getElementById('mapa-grid');
    if (!container) return;

    renderGates(
      dataMaster.getMapa(),
      container,
      { status: 'all' }
    );
  }

  renderStructureTree() {
    const container = document.getElementById('structure-tree');
    if (!container) return;

    const structure = dataMaster.structure || [];

    if (!structure.length) {
      container.innerHTML =
        `<p style="opacity:.6;text-align:center;padding:2rem;">
          Kliknij â€+ Nowe Uniwersumâ€, aby rozpoczÄ…Ä‡.
        </p>`;
      return;
    }

    container.innerHTML = structure.map(n => this.buildTreeNode(n)).join('');
  }

  buildTreeNode(node) {
    const isSelected = this.currentElement?.id === node.id;

    return `
      <div class="tree-node ${isSelected ? 'selected' : ''}" data-id="${node.id}">
        <strong>${this.escapeHtml(node.title || '(Bez tytuÅ‚u)')}</strong>
        <small>${node.type || ''}</small>
        ${Array.isArray(node.children) && node.children.length
          ? `<div class="nested-children">
              ${node.children.map(c => this.buildTreeNode(c)).join('')}
            </div>`
          : ''}
      </div>
    `;
  }

  /* =========================
     STRUKTURA CRUD
  ========================= */
  addRootUniverse() {
    const el = {
      id: this.generateId(),
      type: 'Uniwersum',
      title: 'Nowe Uniwersum',
      content: '',
      children: []
    };

    dataMaster.structure.push(el);
    dataMaster.save(dataMaster.KEYS.STRUCTURE, dataMaster.structure);

    this.renderStructureTree();
    this.selectElement(el.id);
  }

  addChild() {
    if (!this.currentElement) {
      this.status('Wybierz element nadrzÄ™dny');
      return;
    }

    const el = {
      id: this.generateId(),
      type: 'Element',
      title: 'Nowy element',
      content: '',
      children: []
    };

    this.currentElement.children = this.currentElement.children || [];
    this.currentElement.children.push(el);

    dataMaster.save(dataMaster.KEYS.STRUCTURE, dataMaster.structure);
    this.renderStructureTree();
    this.selectElement(el.id);
  }

  selectElement(id) {
    this.currentElement = this.findById(id, dataMaster.structure);
    if (!this.currentElement) return;

    document.getElementById('element-title').value =
      this.currentElement.title || '';

    document.getElementById('element-content').value =
      this.currentElement.content || '';

    this.renderStructureTree();
  }

  findById(id, list) {
    for (const el of list) {
      if (String(el.id) === String(id)) return el;
      if (el.children) {
        const f = this.findById(id, el.children);
        if (f) return f;
      }
    }
    return null;
  }

  /* =========================
     BELLA (LOCAL)
  ========================= */
  bellaAnalyze() {
    if (!this.currentElement?.content) {
      this.status('Brak treÅ›ci do analizy');
      return;
    }

    this.renderSuggestions([
      'âœ… Tekst gotowy â€” brak krytycznych uwag.'
    ]);
  }

  renderSuggestions(list) {
    const el = document.getElementById('suggestions');
    if (!el) return;
    el.innerHTML = list.map(s => `<div>${s}</div>`).join('');
  }

  /* =========================
     STATUS
  ========================= */
  status(msg, t = 4000) {
    const el = document.getElementById('status-bar');
    if (!el) return;

    el.textContent = msg;
    if (t > 0) {
      setTimeout(() => {
        if (el.textContent === msg) el.textContent = 'Gotowy';
      }, t);
    }
  }

  /* =========================
     UTIL
  ========================= */
  generateId() {
    return 'el_' + Math.random().toString(36).slice(2);
  }

  escapeHtml(t = '') {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
  }

  /* =========================
     DYKTOWANIE (bez zmian)
  ========================= */
  initSpeechRecognition() {}
  startDictation() {}
  stopDictation() {}
}

/* =========================
   BOOT
========================= */
document.addEventListener('DOMContentLoaded', () => {
  if (!window.dataMaster) {
    console.error('âŒ DataMaster nie zaÅ‚adowany');
    return;
  }

  window.master = new EterniverseMasterPRO();
  console.log('ğŸŒŒ Eterniverse Master â€” READY');
});